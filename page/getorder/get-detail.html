<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="../../css/mui.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="get-order-comment.css"/>
    <link rel="stylesheet" href="get-detail.css"/>
    <script src="../../js/mui.min.js"></script>
    
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">Detail</h1>
	</header>
	
	<div class="mui-content">
		<div id="scroll-wrapper" class="mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul class="mui-table-view mui-grid-view mui-grid-9">
					<li class="mui-table-view-cell mui-col-xs-12">
						<span class="mui-pull-left title-color mui-text-left name">Name</span>
						<span class="mui-pull-right mui-text-right mui-ellipsis goods-name">--</span>
					</li>
					<li class="mui-table-view-cell mui-col-xs-6">
						<span class="mui-pull-left title-color mui-text-left title-padded">Reward</span>
						<span class="mui-pull-right">
							<div class="goods-value-box">
								<span class="value-color">$</span><span id="goods-value" class="value-color value-size">0.00</span>
								<p class="title-color">not paid</p>
							</div>
						</span>
					</li>
					<li class="mui-table-view-cell mui-col-xs-6">
						<span class="mui-pull-left title-color mui-text-left title-padded">Weight</span>
						<span id="goods-weight" class="mui-pull-right title-weight">0kg</span>
					</li>
					<li class="mui-table-view-cell mui-col-xs-6">
						<div class="title-color title-bottom-padded">Get Time</div>
						<div id="get-time">--:--</div>
					</li>
					<li class="mui-table-view-cell mui-col-xs-6">
						<div class="title-color title-bottom-padded">Deadline</div>
						<div id="deadline">--:--</div>
					</li>
				</ul>
				
				<div class="table-diviver"></div>
				
				<ul class="mui-table-view">
					<li class="mui-table-view-cell desc-after">
						<span class="title-color mui-pull-left title-width">From</span>
						<span id="sendaddr" class="mui-ellipsis content-length">--</span>
					</li>
					<li class="mui-table-view-cell desc-after">
						<span class="title-color mui-pull-left title-width">TO</span>
						<span id="receiveaddr" class="mui-ellipsis content-length">--</span>
					</li>
					<li class="mui-table-view-cell desc-after">
						<span class="title-color mui-pull-left title-width">Value</span>
						<span id="gvalue" class="mui-ellipsis content-length">--</span>
					</li>
					<li class="mui-table-view-cell desc-after">
						<span class="title-color mui-pull-left title-width">Desc</span>
						<span id="info" class="mui-ellipsis content-length">--</span>
					</li>
					<li class="mui-table-view-cell desc-after">
						<div class="porel">
							<span class="img-box">
								<span class="mui-icon mui-icon-plusempty"></span>
							</span>
							<span class="img-box">
								<span class="mui-icon mui-icon-plusempty"></span>
							</span>
							<span class="img-box">
								<span class="mui-icon mui-icon-plusempty"></span>
							</span>
							<span class="img-box">
								<span class="mui-icon mui-icon-plusempty"></span>
							</span>
							<!--<span class="img-box">
								<img src="../../img/2147de349744915c611f470c84c67f94.jpg" width="100%"/>
							</span>-->
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
	
	<footer style="height: 3.2em;" class="mui-bar mui-bar-footer mui-text-center bg-color">
		<button id="markup" class="mui-btn button-first">markup</button>
		<button id="collect" class="mui-btn button-next">collect</button>
	</footer>

	<!-- 遮罩层 -->
	<div id="order-mask"></div>
	<!-- 显示层 -->
	<div id="order-popup">
		<div class="popup-porel">
			<div class="popup-title mui-h3">
				Are you sure?
			</div>
			<div class="sub-title mui-h5">
				This is your adjusted price
			</div>
			<div class="popup-body mui-clearfix">
				<span class="mui-pull-left font-color">
					<span>$</span><span id="current-price">20.00</span>
					<div class="mui-h5 mui-text-center">origin</div>
				</span>
				<span class="plus mui-pull-left">+</span>
				<span class="mui-pull-left font-color">
					<span style="font-size: 1.4em;">$</span>
					<span id="plus-price">1.00</span>
					<div class="mui-h5 mui-text-center">markup</div>
				</span>
				<span class="equal mui-pull-left">=</span>
				<span class="mui-pull-left font-color">
					<span>$</span><span id="total-price">0.00</span>
					<div class="mui-h5 mui-text-center">rel</div>
				</span>
			</div>
			<div class="button-row">
				<button id="ok" type="button">OK</button><button type="button" id="cancel">cancel</button>
			</div>
		</div>
	</div>
	<!-- 加载中的蒙层 -->
	<div id="loading-mask"></div>
	<div id="loading-box">
		<img src="../../img/loading45.gif" alt="loading"/>
	</div>
	
	<script src="../../js/jquery.min.js" ></script>
	<script src="../../js/utils.js"></script>
	<script>
      	mui.init();
      	mui.plusReady(function(){
      		mui("#scroll-wrapper").scroll();
      		
      		var mp;
      		
	      	var mask = document.getElementById("order-mask");
	      	var panel = document.getElementById("order-popup");
	      	// 显示markup弹出层
	      	document.getElementById("markup").addEventListener("tap", function(){
	      		var cshow = document.getElementById("current-price"); 	// 弹出层显示当前价格
	      		var cp = document.getElementById("goods-value").innerHTML;		// 页面显示当前价格
	      		cshow.innerHTML = cp;
	      		var cprice = parseFloat(cp);
	      		mp = parseFloat(document.getElementById("plus-price").innerHTML);		// 获取需要加价的金额
	      		var total = document.getElementById("total-price");
	      		total.innerHTML = cprice + mp;		// 显示总金额
	      		
	      		mask.style.display = "block";
	      		panel.style.display = "block";
	      	},false)
	      	// 隐藏显示层
	      	document.getElementById("cancel").addEventListener("tap", function(){
	      		mask.style.display = "none";
	      		panel.style.display = "none";
	      	}, false)
	      	
	      	mask.addEventListener("tap", function(){
	      		mask.style.display = "none";
	      		panel.style.display = "none";
	      	}, false)
	      	
	      	var order = JSON.parse(plus.storage.getItem("order"));
	      	
	      	// 议价
	      	var getoderpage = plus.webview.getWebviewById("getorder/get-order");
	      	document.getElementById("ok").addEventListener("tap", function(){
	      		plus.nativeUI.showWaiting("议价中...", {
	      			background : "#ccc"
	      		});
	      		mui.ajax(BASEURL + "deliver/bargain", {
	      			data : {
	      				orderId : order.orderid,
	      				money : mp
	      			},
	      			type : "post",
	      			success : function(data){
	      				if(data.ret == 1){
	      					plus.nativeUI.closeWaiting();
	      					mui.alert("议价成功", "议价");
	      					if(getoderpage){
	      						getoderpage.show("slide-in-left", 300);
	      						setTimeout(function(){
	      							plus.webview.currentWebview().close("fade-out", 200);
	      						}, 320)
	      					} else {
	      						plus.webview.getLaunchWebview().show("slide-in-left", 300);
	      						setTimeout(function(){
	      							plus.webview.currentWebview().close("fade-out", 200);
	      						}, 320)
	      					}
	      					mask.style.display = "none";
	      					panel.style.display = "none";
	      				} else if (data.ret == 2){
	      					plus.nativeUI.closeWaiting();
	      					mui.alert("已加价，不可重复加价", "议价");
	      					mask.style.display = "none";
	      					panel.style.display = "none";
	      				}
	      			},
	      			error : function(err){
	      				console.log(err);
	      			}
	      		})
//	      		alert("nihao")
	      	}, false);
	      	
	      	
	      	mui.ajax(BASEURL + "order/goodShow", {
	      		data : {
	      			orderId : order.orderid,
	      			type : "comm"
	      		},
	      		type : "post",
	      		success : function(data){
//	      			console.log(JSON.stringify(data));
	      			if(data.ret == 1){
	      				$(".goods-name").html(data.res.gName);		// 货物名称
		      			$("#goods-value").html(data.res.money);		// 价值
		      			$("#goods-weight").html(data.res.gWeight+ "kg");	// 重量
		      			$("#get-time").html(data.res.getTime);		// 获取时间
		      			$("#deadline").html(data.res.finTime);		// 期望时间
		      			$("#sendaddr").html(data.res.sendAddr);		// 发送地
		      			$("#receiveaddr").html(data.res.receiveAddr)	// 接收地
		      			$("#gvalue").html(data.res.gValue);		// value
		      			$("#info").html(data.res.info);		// 信息描述
		      			var pic = data.res.pics;
		      			
		      			var n = BASEURL.indexOf('/api/');
		      			
						var per = BASEURL.substring(0,n);
						var len = pic.length;
						for(var i = 0; i<len;i++){
							var url = per + pic[i].path;
							var html = '<img src=' + url +' width="100%">';
							document.querySelectorAll(".img-box")[i].innerHTML = html;
						}
						// 300毫秒之后清除等待框
		      			setTimeout(function(){
		      				var lmask = document.getElementById("loading-mask");
		      				var lbox = document.getElementById("loading-box");
		      				var mcl = lmask.classList;
		      				var bcl = lbox.classList;
		      				mcl.add("fade-out");
		      				bcl.add("fade-out");
		      				// 过渡动画结束的时候执行该事件
		      				lmask.addEventListener("webkitTransitionEnd", function(){
			      				document.getElementById("loading-mask").style.display = "none";
			      				document.getElementById("loading-box").style.display = "none";
			      				mcl.remove("fade-out");
		      					bcl.remove("fade-out");
		      				}, false)
		      			}, 300)
	      			}
	      		},
	      		error : function(xhr, type){
	      			console.log(type);
	      		}
	      	})
      	})

    </script>
</body>
</html>