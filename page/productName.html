<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="../js/mui.js"></script>
    <link href="../css/mui.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/cy_log_up.css" />
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
</head>
<body>
	<header class="mui-bar mui-bar-nav hea_bg">
		<a class="mui-icon mui-icon-left-nav color_w"></a>
		<h1 class="mui-title color_w">注册</h1>
	</header>
	<div class="mui-content bg">
		<!--log框-->
		<div class="w_log ">
			<div class="log_img">
				<img src="../img/log.png"/>
				     <span style="color: #06495A;"> <b>Along</b></span>
			</div>
		</div>
		<!--输入框-->
		<div class="log_contain bg_w box_shadow">
			<div class="log_input ">
				<img src="../img/pho.png" alt="" />
				<input type="number" class="log_input_" placeholder="phone number"  id="signup-phone-number"/>	
			</div>
			<div class="log_clear "><!--中间间隙--></div>
			<div class="log_input">
				<img src="../img/valcode.png" alt="" />
				<input type="number" class="log_input_" placeholder="valcode" style="width: 65%;" id="signup-valcode"/>	
				<div class="mui-pull-right find_r" id="get-code">get code</div>
			</div>
		</div>
			
		<div class="log_contain bg_w box_shadow" style="margin-top: .5em;">
			<div class="log_input one">
				<img src="../img/password.png" alt="" />
				<input type="number" class="log_input_" placeholder="password" style="width:85%;" id="signup-pwd"/>	
				<img src="../img/1182351.png" alt=""  class="input_chan " id="password_chan"/>
			</div>
			<div class="log_clear"><!--中间间隙--></div>
			<div class="log_input">
				<img src="../img/confirm.png" alt="" />
				<input type="number" class="log_input_ border bg_or" placeholder="confirm password" id="signup-com-pwd" />
				
			</div>
		</div>
		<div class="log_span">
			<input type="checkbox" class="bg_w" id="signup-agree" checked="checked"/> <span class="color">i agree with the</span>
			<a href="" class="log_color" id="signup-agree">service rules</a>
        </div>
        <footer class="mui-bar mui-bar-footer  none_box"  >
			<div class="log_button color_w" id="submit-button">Next Step</div>
		</footer>
	</div> 
	<script src="../js/utils.js"></script>
	<script>
	   
			// 注册验证
        mui.plusReady(function(){
        		// 根据手机号，获取验证码
				document.getElementById("get-code").addEventListener("tap", function(e) {
						var opnum = document.getElementById("signup-phone-number"),
							pnum = opnum.value.trim();
								// 手机号码验证正则
				var reph = /^[0-9]{6,12}$/;
				var repw = /^[\\.a-zA-Z0-9_]{6}$/;
						if (reph.test(pnum)) {
							var codedata = {
									phone: pnum
								}
								// ajax发送请求验证信息   【xxx】ip地址及端口号				========================    后台交互数据
							mui.plusReady(function(){
								mui.ajax(BASEURL + "auth/regDynCode", {
									data: codedata,
									type: "post",
									success: function(data) {
										if (data.ret == 1) { //获得验证码成功
											console.log(data.code)
											document.getElementById('signup-valcode').value = data.code;
										} else if (data.ret == -1) {
											mui.toast("注册账户已存在！")
										}
									},
									error: function(xhr, type, errorThrown) {
										errorhandle(type);
									}
								})
							})
						} else {
							mui.toast("请正确输入您的手机号码")
						}
						e.preventDefault();
					}, false)
        	
				function signUp() { 
					// 注册的电话号码
					var opnum = document.getElementById("signup-phone-number"),
						pnum = opnum.value.trim();
					// 注册的密码
					var opwd = document.getElementById("signup-pwd"),
						pwd = opwd.value.trim();
					// 确定密码
					var ocompwd = document.getElementById("signup-com-pwd"),
						compwd = ocompwd.value.trim();
					// 手机验证码
					var ocode = document.getElementById("signup-valcode"),
						code = ocode.value.trim();
					// 确定规则
					var check = document.getElementById("signup-agree");
					var flag = true; // 判断是否验证是否成功
					if (pnum && pwd && compwd && code) {
						if (check.checked) {
							// 手机号码验证
							if (!reph.test(pnum)) {
								mui.toast("请确定输入手机号");
								flag = false;
							}   
							// 密码验证失败
							if (!repw.test(pwd) && !(pwd == compwd)) {
								mui.toast("密码验证失败")
								flag = false;
							}
							// 手机验证码验证
							if (!(/^[0-9]{6,6}$/.test(code))) {
								mui.toast("手机验证码错误");
								flag = false;
							}
							// 传送后台数据
							if (flag) {
								var getcode = document.getElementById('signup-valcode').value
								var data = {
									type: 1,
									phone: pnum,
									code: getcode,
									pwd: pwd,
									repwd: compwd
								}
								data.mac = plus.device.imei;
								data.imsi = plus.device.imsi;
								data.systemName = plus.device.vendor
								data.systemVersion = plus.device.model;
								mui.ajax(BASEURL + "auth/reg", {
									type: "post",
									data:data,
									success: function(obj) {
										if (obj.token) {
											setstorage('token', obj.token);
											successcb();
										}
										if (obj.ret == -1) {
											mui.toast("账户已经注册")
										} else if (obj.ret == -2) {
											mui.toast("验证码不正确")
										}
									},
									error: function(xhr, type, errorThrown) {
										console.log(type)
										errorhandle(type)
									}
								})
							}
						} else {
							mui.toast("请审查选择相关规则")
						}
					} else {
						mui.toast("请填写完资料信息");
					}
				}  
			   function successcb(){
					plus.webview.getLaunchWebview().show('slide-in-left')
				}
			 //密码可见
			var img=document.getElementById('img_change');
		    img.addEventListener('tap',function(){	
	        var pass=document.getElementById('signup-pwd')
	    	 pass.setAttribute('type','text');  	
	       })
		    
		var submit=document.getElementById('submit-button');
       submit.addEventListener('tap',function(){
			    signUp();
        })
 })
	</script>
</body>
</html>