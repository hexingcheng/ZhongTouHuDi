<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="../../js/mui.js"></script>
    <link href="../../css/mui.css" rel="stylesheet"/>
    <link rel="stylesheet" href="login_new.css" />
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
    <style type="text/css">
    	
    </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav login_headr">
		<a class="mui-icon mui-icon-left-nav mui-action-back login_color mui-action-back"></a>
		<span class="login_title">Find My Password</span>
	</header>
	<div class="tips mui-hidden">登录中...</div>
	<div class="mui-content">
		<div class="login_log">   
			<img src="../../img/log.png" class="big_img" alt="" />
		    <img src="../../img/along.png" class="small_img" alt="" />
		</div>
		<!--输入框-->
		<div class="login_input_contain">
			<div class="login_input login_bor_bottom">
				<img src="../../img/pho.png"  class="login_map" alt="" />
				<div class="input_div_">
					<input type="tel" class="login_input_" id="signup-phone-number" placeholder="phone number"/>
				</div>
			</div> 
			<div class="login_input login_bor_bottom">
				<img src="../../img/valcode.png"  class="login_map" alt=""/>
				<div class="login_input_get"  >
					<span id="get-code">get code</span>
					<span id="get-time" style="color: #FFE801;"></span>
				</div>
				<div class="input_div">
					<input type="tel" class="login_input_" id="signup-valcode" placeholder="valcode"/>
				</div>
			</div>
			<div class="login_input login_bor_bottom">
				<img src="../../img/password.png"  class="login_map" alt=""/>
				<div class="login_change login_eye_show" >
					<img src="../../img/eye.png" class="eye_one" alt="" >  
					<img src="../../img/1182351.png" class="eye_two"/>
				</div> 
				<div class="input_div">
					<input type="password" class="login_input_ change pwd" id="signup-pwd"  placeholder="password"/>
				</div>
			</div>
			<div class="login_input ">
				<img src="../../img/confirm.png"  class="login_map" alt="" />
				<div class="input_div_">
					<input type="password" class="login_input_" id="signup-com-pwd" placeholder="confirm password" />
				</div>
			</div>
		</div>
	    <div class="login_info" style="margin-bottom: 5em;">
	    	<div class="login_checkbox"><input type="checkbox" id="signup-agree" checked="checked" /></div>
	    	<span id="signup-agree"> I agree with the</span> <a href="" class="log_color">service rules</a>
	    </div>
	</div>
	<footer class="login_footer">
		<div class="login_button" id="submit-button">Log on</div>
	</footer>
	<script src="../../js/utils.js"></script>
	<script type="text/javascript" src="../../js/jquery.min.js" ></script>
	<script type="text/javascript">
	mui.plusReady(function(){
		var reph = /^[0-9]{6,12}$/; 
		var repw = /^[\\.a-zA-Z0-9_]{6}$/;
		    $("#get-code").on("tap", function(e) {
				var pnum = $("#signup-phone-number").val().trim();	
				if(reph.test(pnum)){
					time();//打开计时器
					var codedata={  
							phone:pnum,
							type:2
						}
				// ajax发送请求验证信息   【xxx】ip地址及端口号				========================    后台交互数据
				myAjax({url:"auth/getDynCode",data:codedata},function(data) {
										if (data.ret == 1) { //获得验证码成功
											$('#signup-valcode').val(data.code);
										} else if (data.ret == -1) {
											mui.toast("验证码异常")
										}
									}, function(xhr, type){
										console.log(xhr.status);
									})
						}else{
								mui.toast("请正确输入您的手机号码")
		  										}
						e.preventDefault();
					});
		
				function finpwd() { 
					// 输入的电话号码
					var	pnum = $("#signup-phone-number").val().trim();
					// 新的密码
					var	pwd = $("#signup-pwd").val().trim();
					// 确定密码
					var compwd = $("#signup-com-pwd").val().trim();
					// 手机验证码
					var code = $("#signup-valcode").val().trim();
					// 确定规则
					var check =$("#signup-agree").attr('checked');
					var flag = true; // 判断是否验证是否成功
						if (check) {
							// 手机号码验证
							if(true){
								
								if (!reph.test(pnum)) {
									mui.toast("手机号输入有误");
									flag = false;
									return;
								} 
							}else{
								mui.toast('请输入手机号');
								flag=false;
								return;
								
							}
							// 手机验证码验证
							if(code){
									if (!(/^[0-9]{6,6}$/.test(code))) {
										mui.toast("手机验证码输入有误");
										flag = false;
										return;
									}
							}else{
								mui.toast('请输入验证码');
								flag=false;
								return;
							}
							if(pwd){
								if(compwd){
										if ( !(pwd == compwd)) {
											mui.toast("密码两次输入有误")
											flag = false;
										}
									}else{
										mui.toast('请输入确认密码');
										flag=false;
										return;
									}
							}else{
								mui.toast('请输入密码');
								flag=false;
								return;
							}
							if(!check){
								mui.toast('请同意相关条例');
								flag=false;
							}
							// 传送后台数据
							if (flag) {
								var getcode = $('#signup-valcode').val();
								var data = {
									phone: pnum,
									code: getcode,
									nowpwd: pwd,
									repwd: compwd
								}
								alert(JSON.stringify(data));
//								data.mac = plus.device.imei;
//								data.imsi = plus.device.imsi;
//								data.systemName = plus.device.vendor
//								data.systemVersion = plus.device.model;
								myAjax({url:"auth/findPwd",data:data},function(obj) {
									alert(JSON.stringify(obj));
										if (obj.token) {
											setstorage('token', obj.token);
											successcb();
										}
										if (obj.ret == -1) {
											mui.toast("验证码异常")
										} else if (obj.ret == 0) {
											mui.toast("参数异常")
										}else if(obj.ret == 1){
											mui.toast("密码修改成功");
											successcb(); 
										}
									}, function(xhr, type, errorThrown) {
										console.log(type)
										errorhandle(type)
									},function(){
										mui.toast("请检测网络连接！");
									})
							}
						}	
	        };
			$('#submit-button').on('tap',function(e){
				finpwd();
           });
	    //password可见切换
			$('.login_eye_show').on('tap',function(){
	        	var show=$('.pwd').attr('type');
				if(show=="password"){
					$('.pwd').attr('type','text');
					$('.eye_one').css('display','none');
					$('.eye_two').css('display','block');
				}else{
					$('.pwd').attr('type','password');
					$('.eye_one').css('display','block');
					$('.eye_two').css('display','none');
				}
			})
		  function successcb() {
						plus.webview.currentWebview().close();
						plus.webview.getLaunchWebview().show('slide-in-left')
					}
		  function time(){
		  	$('#get-code').css('display','none');
		  	$('#get-time').css('display','block');
			  	var a=60;
			  	b=function(){
			  		a--;
			  	    $('#get-time').html(a);
			  		if(a==0){
			  			$('#get-code').css('display','block');
			  			$('#get-time').css('display','none');
			  		}
			  	}
			  	set=setInterval('b()',1000);
			  	setTimeout("clearInterval(set)",61000);
		  }
})	
		</script>
</body>
</html>