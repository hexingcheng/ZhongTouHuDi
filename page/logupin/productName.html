<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="../../js/mui.js"></script>
    <link href="../../css/mui.css" rel="stylesheet"/>
    <link rel="stylesheet" href="login_new.css" />
</head>
<body> 
	<header class="mui-bar mui-bar-nav nav_header">
		<img src="../../img/left.png" class="header_left_img mui-action-back" alt="" />
		<span >Sign Up</span>
	</header>
	<div class="mui-content">
		<div class="login_log">
			<img src="../../img/log.png" class="big_img" alt="" />
		    <img src="../../img/along.png" class="small_img" alt="" />
		</div>
		<!--输入框-->  
		<div class="login_input_contain">
			<div class="login_input login_bor_bottom">
				<img src="../../img/pho.png" class="login_map" alt="" />
				<div class="input_div">
				    <input type="tel" class="login_input_" id="signup-phone-number" placeholder="phone number"/>
				</div>
			</div> 
			<div class="login_input login_bor_bottom">
				<img src="../../img/valcode.png" class="login_map" alt=""/>
				<div class="login_input_get"> 
					<span id="get-code">get code</span>
					<span id="get-time" style="color: #FFE801;"></span>
				</div>
				<div class="input_div">
				    <input type="tel" class="mui-pull-left login_input_"  id="signup-valcode" placeholder="valcode"/>
				</div>
			</div>
			<div class="login_input login_bor_bottom">
				<img src="../../img/password.png" class="login_map" alt=""/>
				<div class="login_change login_eye_show" >
					<img src="../../img/eye.png" class="eye_one" alt="" >  
					<img src="../../img/1182351.png" class="eye_two" />
				</div> 
				<div class="input_div">
			        <input type="password" class="mui-pull-left pwd login_input_" id="signup-pwd"   placeholder="password"/>
			    </div>
			</div>
			<div class="login_input ">
				<img src="../../img/confirm.png" class="login_map" alt="" />
				<div class="input_div_">
					<input type="password" class="login_input_" id="signup-com-pwd" placeholder="confirm password" />
				</div>
			</div>
		</div>
	    <div class="login_info" style="margin-bottom: 5em;">
	    	<div class="login_checkbox"><input type="checkbox" id="signup-agree" checked="checked" /></div>
	    	<span id="signup-agree">I agree with the</span> <a href="" class="log_color">service rules</a>
	    </div>
	</div> 
	<div class="tips mui-hidden">登录中...</div>
	<footer class="mui-bar mui-bar-footer login_bg">
		<div class="nav_footer" id="submit-button">submit</div>
	</footer>
	<script src="../../js/utils.js"></script>
		<script type="text/javascript" src="../../js/jquery.min.js" ></script>
	<script type="text/javascript">
		 // 注册验证
		mui.plusReady(function(){
				plus.webview.currentWebview().setStyle({scrollIndicator:'none'});//移除页面的滚动条
				// 根据手机号，获取验证码
			$("#get-code").on("tap", function(e) {
					var pnum = $("#signup-phone-number").val().trim();
					// 手机号码验证正则
					var reph = /^[0-9]{6,12}$/;
					var repw = /^[\\.a-zA-Z0-9_]{6}$/;
					if (reph.test(pnum)) {
						time();
						var codedata = {
							phone: pnum,
							type:"1"
						}
//						alert(codedata.phone)
                        myAjax({url:"auth/getDynCode",data:codedata},function(data) {
									if (data.ret == 1) { //获得验证码成功
										
										$('#signup-valcode').val(data.code);
									} else if (data.ret == -1) {
										mui.toast("注册账户已存在！")
									$('#signup-phone-number').val("");
									}
								},function(xhr, type, errorThrown) {
									errorhandle(type);
								},function(){
									mui.toast('请检测网络！');
								})
							// ajax发送请求验证信息   【xxx】ip地址及端口号				========================    后台交互数据
					} else {
						mui.toast("请正确输入您的手机号码")
					}
					e.preventDefault();
				})

				function signUp() { 
					// 注册的电话号码
					var reph = /^[0-9]{6,12}$/;
					var repw = /^[\\.a-zA-Z0-9_]{6}$/;
					var pnum = $("#signup-phone-number").val().trim();
					// 注册的密码
					var pwd = $("#signup-pwd").val().trim();
					// 确定密码
					var compwd = $("#signup-com-pwd").val().trim();
					// 手机验证码
					var code = $("#signup-valcode").val().trim();
					// 确定规则
					var check = $("#signup-agree").attr('checked');
					var flag = true; // 判断是否验证是否成功
						if(true){
							
							// 手机号码验证
							if(pnum){
								
								if (!reph.test(pnum)) {
									mui.toast("手机号输入有误");
									flag = false;
									return;
								}
							}else{
								mui.toast('请输入手机号');
								flag=false;
								return;
								
							}
							// 手机验证码验证
							if(code){
									if (!(/^[0-9]{6,6}$/.test(code))) {
										mui.toast("手机验证码输入有误");
										flag = false;
										return;
									}
							}else{
								mui.toast('请输入验证码');
								flag=false;
								return;
							}
							if(pwd){
								if(compwd){
										if ( !(pwd == compwd)) {
											mui.toast("密码两次输入有误")
											flag = false;
										}
									}else{
										mui.toast('请输入确认密码');
										flag=false;
										return;
									}
							}else{
								mui.toast('请输入密码');
								flag=false;
								return;
							}
							if(!check){
								mui.toast('请同意先关条例');
								flag=false;
							}
							// 传送后台数据
							if (flag) {
								var getcode =$('#signup-valcode').val();
								var data = {
									type: 1,
									phone: pnum,
									code: getcode,
									pwd: pwd,
									repwd: compwd
								}
								data.mac = plus.device.imei;
								data.imsi = plus.device.imsi;
								data.systemName = plus.device.vendor
								data.systemVersion = plus.device.model;
								myAjax({url: "auth/reg",data:data},function(obj) {
										if (obj.token) {
											setstorage('token', obj.token);
											getacountinfo(); 
											plus.webview.getLaunchWebview().show('slide-in-left', 200);
											setTimeout(function(){
												plus.webview.currentWebview().close();
											},500)
										}
										if (obj.ret == -1) {
											mui.toast("账户已经注册")
											return ;
										} else if (obj.ret == -2) {
											mui.toast("验证码不正确")
											return;
										}
									},function(xhr, type, errorThrown) {
										console.log(type)
										errorhandle(type)
									},function(){
										mui.toast('请检测网络！');
									})
				                }
							} 
                   }
				function getacountinfo() {
					mui.ajax(BASEURL + 'account/info', {
						type: 'post',
						success: function(data) {
							mui.toast('获取初始账户信息成功');
							if(getstorage('personinfo')){
								plus.storage.removeItem('personinfo')
							}
							setstorage('personinfo',JSON.stringify(data.res));
							var i = plus.webview.getLaunchWebview();
							mui.fire(i,'setaccount',data.res);
						},
						error:function(xhr,type){
							console.log(xhr.status+":"+type);
						}
					})
				}
					//密码可见
				var submit = document.getElementById('submit-button');
				submit.addEventListener('tap', function() {
					signUp();
				})
				//password可见切换
				$('.login_eye_show').on('tap',function(){
                	var show=$('.pwd').attr('type');
					if(show=="password"){
						$('.pwd').attr('type','text');
						$('.eye_one').css('display','none');
						$('.eye_two').css('display','block');
					}else{
						$('.pwd').attr('type','password');
						$('.eye_one').css('display','block');
						$('.eye_two').css('display','none');
					}
				})
		//时间函数  
		function time(){
		  	$('#get-code').css('display','none');
		  	$('#get-time').css('display','block');
			  	var a=60;
			  	b=function(){
			  		a--;
			  	    $('#get-time').html(a);
		  		if(a==0){
		  			$('#get-code').css('display','block');
		  			$('#get-time').css('display','none');
		  		}
			  	}
			  	    set=setInterval('b()',1000);
			  	setTimeout("clearInterval(set)",61000);
		  }
	})
</script>
</body>
</html>