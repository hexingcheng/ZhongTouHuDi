<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/share_main.css" />
		<link rel="stylesheet" href="../../css/common/popup.css" />
		<script src="../../js/mui.js"></script>
		<script src="../../js/common/popup.js"></script>
		<style>
			html,
			body {
				height: 100%;
				width: 100%;
			}
			.mui-bar-nav~.mui-content {
				padding-top: 52px;
			}
			.center_headpic {
				width: 80px;
				height: 80px;
				position: absolute;
				bottom: 0;
				left: 50%;
				z-index: 100;
				border-radius: 50%;
				margin-left: -40px;
				margin-bottom: -20px;
			}
			.center_headpic .heade_pic {
				height: 100%;
				width: 100%;
				overflow: hidden;
				border-radius: 50%;
				display: inline-block;
			}
			.center_bg {
				width: 100%;
				height: 10em;
				position: relative;
				background: url(../../img/details_3.jpeg) no-repeat;
				background-size: 100% 100%;
				margin-top: 52px;
			}
			.center_headpic .header_camara {
				width: 36px;
				height: 36px;
				border-radius: 18px;
				position: absolute;
				background-color: #fff;
				bottom: 5px;
				right: 0;
			}
			.center_bg_edit {
				width: 34px;
				height: 34px;
				position: absolute;
				bottom: 0;
				right: 0;
			}
			.header_camara img {
				max-width: 100%;
				height: auto;
			}
			.nation_select {
				width: 70%;
				height: 80%;
				z-index: 999;
				overflow-y: scroll;
				top: 10%;
				left: 50%;
				margin-left: -35%;
				position: absolute;
				background-color: #FFF;
				display: none;
			}
			.select_sex {
				width: 100%;
				height: 50px;
				overflow: hidden;
			}
			.mui-table-view-cell .select_sex input {
				height: auto;
				font-size: 14px;
				width: 14px;
			}
			.li_input_s img {
				width: 34px;
				height: 34px;
				margin: 8px;
			}
			.edit_hide {
				display: none;
			}
			/**弹出框*/
			.center_pop {
				z-index: 502;
				width: 70%;
				line-height: 2em;
				overflow: hidden;
				position: fixed;
				display: none;
				padding: .8em;
				background-color: #fff;
				top: 50%;
				margin-top: -10%;
				left: 50%;
				margin-left: -35%;
			}
			.center_pop input {
				width: 100%;
				height: 40px;
				border: 0;
				font-size: 14px;
				line-height: 14px;
				margin-bottom: .5em;
				padding-bottom: 0;
				border-radius: 0;
				border-bottom: 2px solid #3FA86A;
			}
			.gitpic {
				height: 80px;
				width: 80px;
				display: inline-block;
				border: 2px solid #fff;
				border-radius: 50%;
				overflow: hidden;
				text-align: center;
			}
			.input_div input {
				border: none;
				border-bottom: 1px solid #ccc;
				border-radius: 0;
				margin-top: 5px;
			}
			.mui-table-view-cell .li_left_title{
				width: 6em;
			}
			.main_mask{
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0; 
				z-index: 100; 
				background-color: transparent;
			}
			.loading-box {
				position: absolute;
				z-index: 999;
				width: 5em; 
				height: 5em;
				left: 50%;
				overflow: hidden; 
				margin-left: -40px;
				top: 50%;
				margin-top: -40px;
			}
		</style>
	</head>
 
	<body>
		<header class="mui-bar mui-bar-nav nav_header">
			<img src="../../img/left.png" alt="" class="header_left_img mui-action-back" />  
			<span>personal</span>
			<img src="../../img/edit2.1.png" class="header_right_img center_edit" alt="" id="center_edit"/>
			<img src="../../img/save.png" class="header_right_img center_save" alt="" style="display: none;" id="center_save"/>
		</header>
		<!-- 加载中的蒙层 -->
		<div id="loading-mask"></div>
		<div id="loading-box">
			<img src="../../img/loading2.gif" alt="loading" width="100%" />
		</div>
		<div class="main_mask mui-hidden" id="main_mark"> 
			<div class="loading-box"> 
			<img src="../../img/loading2.gif" alt="loading" width="100%" />
			</div>
		</div>  
		<!--蒙版-->
		<div class="content_mask mui-hidden"></div>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="center_bg">
						<div class="center_headpic" id="center_headpic">
							<a href="#gitpic" class="gitpic">
								<img src="../../img/defualt.png" class="heade_pic" id="headpic" />
								<div class="header_camara ">
									<img src="../../img/camera.png" />
								</div>
							</a>
						</div>
						<img src="../../img/edit3.png" class="center_bg_edit" />
					</div>
					<div class="content_clear">
						<!--中间间隙-->
					</div>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<div class="li_left_title">
								<span>family name</span>
							</div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide " name="one" />
							<div class="li_input_s ">
								<input type="text" id="familyName" disabled="disabled" class="edit_input one" />
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="li_left_title">
								<span>first name</span>
							</div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide " name="two" />
							<div class="li_input_s">
								<input type="text" id="firstName" disabled="disabled" class=" edit_input two " />
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="li_left_title">
								<span>sex</span>
							</div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide" name="two" />
							<div class="li_input_s">
								<span class="edit_show male sex mui-hidden"><span class="mui-pull-left">male</span><img src="../../img/male2.png" alt="" /></span>
								<span class="edit_show female sex mui-hidden"><span class="mui-pull-left">female</span><img src="../../img/female2.png" alt="" /></span>
								<div class="select_sex edit_hide">
									<lable>male </lable>
									<input type="radio" name="sex" checked="checked" value="man" id="person_sex" />
									<lable>female </lable>
									<input type="radio" name="sex" />
								</div>
							</div>
						</li>
					</ul>
					<div class="content_clear">
						<!--中间间隙-->
					</div>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<div class="li_left_title">
								<span>phone</span>
							</div>
							<div class="li_input_l">
								<input type="number" disabled="disabled" id="phone" />
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="li_left_title">
								<span>password</span>
							</div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide" name="three" />
							<div class="li_input_s">
								<input type="password" value="123456" disabled="disabled" class="edit_input three " id="password" />
							</div>
						</li>
					</ul>
					<div class="content_clear">
						<!--中间间隙-->
					</div>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							<div class="li_left_title"><span>E-mail</span></div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide" name="four" />
							<div class="li_input_s">
								<input type="text" id="email" disabled="disabled" class="edit_input four" />
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="li_left_title"><span>nationnality</span></div>
							<img src="../../img/edit.png" alt="" class="li_right_img edit_hide" name="five" />
							<div class="li_input_l" id="nation_">
								<span id="nation"></span>
							</div>
						</li>
					</ul>
					<div class="content_clear">
						<!--中间间隙-->
					</div>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" id="info">
							<div class="li_left_title"><span>credibility</span></div>
							<div class="li_input_l">
								<span id="ptitle" class="mui-pull-left"></span>
								<img src="../../img/jiangbei.png" class="li_left_img" alt="" />
								
							</div>
						</li>
						<li class="mui-table-view-cell" class="open_apply" id="open_apply">
							<div class="li_left_title"><span>deliver</span></div>
							<img src="../../img/enter.png" class="li_right_img" alt="" />
						</li>
					</ul>
					<div class="content_clear">
						<!--中间间隙-->
					</div>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" id="wallet_pwd">
							<div class="li_left_title"><span>payword</span></div>
							<img src="../../img/enter.png" class="li_right_img" alt="" />
						</li>
					</ul>
				</div>
			</div>
		</div>

		<div class="nation_select " id='nation_select_'>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">中国</li>
				<li class="mui-table-view-cell">美国</li>
				<li class="mui-table-view-cell">日本</li>
				<li class="mui-table-view-cell">韩国</li>
				<li class="mui-table-view-cell">朝鲜</li>
				<li class="mui-table-view-cell">德国</li>
				<li class="mui-table-view-cell">英国</li>
				<li class="mui-table-view-cell">法国</li>
				<li class="mui-table-view-cell">瑞士</li>
				<li class="mui-table-view-cell">美国</li>
				<li class="mui-table-view-cell">加拿大</li>
				<li class="mui-table-view-cell">意大利</li>
				<li class="mui-table-view-cell">柬埔寨</li>
				<li class="mui-table-view-cell">老挝</li>
				<li class="mui-table-view-cell">泰国</li>
				<li class="mui-table-view-cell">俄罗斯</li>
				<li class="mui-table-view-cell">澳大利亚</li>
				<li class="mui-table-view-cell">巴基斯坦</li>
				<li class="mui-table-view-cell">以色列</li>
				<li class="mui-table-view-cell">缅甸</li>
				<li class="mui-table-view-cell">蒙古</li>
				<li class="mui-table-view-cell">牙买加</li>
				<li class="mui-table-view-cell">印度</li>
				<li class="mui-table-view-cell">非洲</li>
				<li class="mui-table-view-cell">匈牙利</li>
				<li class="mui-table-view-cell">奥地利</li>
				<li class="mui-table-view-cell">瑞士</li>
			</ul>
		</div>
		<div id="gitpic" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell " id="bycamera">
					拍照
				</li>
				<li class="mui-table-view-cell" id="bygallery">
					相册
				</li>
			</ul>
			<ul class="mui-table-view">
				<a href="#gitpic" id="trigger">
					<li class="mui-table-view-cell">
						<b>取消</b>
					</li>
				</a>
			</ul>
		</div> 
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/utils.js"></script>
		<script src="../../js/comment.js"></script>
		<script>
			mui.plusReady(function() {
				var data = '';
				var d_status = '';
				plus.webview.currentWebview().setStyle({
					scrollIndicator: 'none'
				});
				//调用蒙版
				mui('.mui-scroll-wrapper').scroll({
					bounce: false
				}); 
				myAjax({
						url: 'account/info',
					},
					function(obj) {
						if (obj.ret == 1) {
							$('#loading-mask').css('display', 'none');
							$('#loading-box').css('display', 'none');
							var data = obj.res; 
							var n = BASEURL.indexOf('/a');
							var imgurl = BASEURL.substring(0, n);
							var pic = imgurl + data.headPic;
							$('#nation_').removeClass('nation_');
							if (data.headPic) {
								$('#headpic').attr('src', pic)
							}
							$('#familyName').val(data.familyName);
							$('#firstName').val(data.firstName);
							$('#email').val(data.email);
							$('#nation').text(data.nation);
							$('#phone').val(data.phone);
							$('#ptitle').text(data.ptitle);
							if (data.sex == 1) {
								$('.male').removeClass('mui-hidden');
							} else {
								$('.female').removeClass('mui-hidden');
							} 
						}
					},
					function(xhr, type) {
						mui.toast(xhr.status + ":" + type)
					})
				document.querySelector('#bycamera').addEventListener('tap',function(){ 
					bycamera()
					mui('#gitpic').popover('toggle');
				})
				document.querySelector('#bygallery').addEventListener('tap', function() {
					bygallery();
					mui('#gitpic').popover('toggle');
				})

				function bycamera() { 
					var camera = plus.camera.getCamera();
					var res = camera.supportedImageResolutions[0];
					var fmt = camera.supportedImageFormats[0];
					camera.captureImage(function(path) {
						$('#main_mark').removeClass('mui-hidden');
						dealpic(path);
					})
				};
				//图片压缩
				function dealpic(path) { 
						plus.io.resolveLocalFileSystemURL(path, function(entry) {
							var local = entry.toLocalURL();
							path = plus.io.convertLocalFileSystemURL(path);
//						$('.center_headpic').css('background', 'url(' + path + ')'); //得到头像 
							dealImage(local, {
								width: 17 * 6, 
								quality: 0.9
							}, function(base) {
								console.log("压缩后：" + base.length / 1024 + "KB");
								data = {
									imgName: Math.floor(Math.random() * 100000) + ".jpg",
									imgData: base // base字符串
								}
								myAjax({
										url: "common/file/imgUp",
										data: data
									},
									function(obj) { 
										if (obj.ret == 1) {
											data = {
												fid: obj.res.fid
											}
											var head = obj.res.path;
//											var n = BASEURL.indexOf('/a');
//											var headpicurl = BASEURL.substring(0, n);
											//头像上传
											myAjax({
												url: 'account/setHeadPic',
												data: data
											}, function(obj) {
												if (obj.ret == 1) {  
//													var p = headpicurl + head;
													$('#headpic').attr('src', path); 
													$('#main_mark').addClass('mui-hidden');
													var i = plus.webview.getLaunchWebview();
													mui.fire(i, 'setaccount', {
														headPic: head
													})
												} else {
													mui.toast('图片上传至服务器存在问题');
												}
											}, function(xhr, type) {
												mui.toast(xhr.status);
											})
										} else {
											mui.toast('请先登录在操作！');
										}
									},
									function(xhr, type) {
										console.log(xhr.status);
									})
							})
						})  
					}
					//bg galary

				function bygallery() {
						plus.gallery.pick(function(path) {
							$('#main_mark').removeClass('mui-hidden');
							dealpic(path);
						}, function(e) {
							mui.toast('选择图片失败' + e)
							showobj(e)
						}, {
							filter: 'image',
							multiple: false
						})
					}
					//编辑信息
				var token = '';

				function update(callback) {
					var pwd = $('#pop_password').val();
					if (pwd) {
						data = {
							pwd: pwd
						}
						myAjax({
							url: 'account/updateSet',
							data: data
						}, function(obj) {
							if (obj.ret == 1) {
								$('.edit_show').css('display', 'none');
								$('#password').val(pwd);
								$('#pop_password').val('');
								$('.edit_hide').css({
									'display': 'block'
								});
								$('.edit_input').removeAttr('disabled');
								$('#nation_').addClass('nation_');
								$('#open_apply').removeClass('open_apply');//撤除deliver的事件
							} else if (obj.ret == 2) {
								mui.toast('密码错误');
								$('.center_edit').css('display', 'block');
								$('.center_save').css('display', 'none');
								$('#nation_select_').css('display', 'none');
							}
							token = obj.res.token;
							callback && callback();
						}, function(xhr, type) {
							alert(xhr.status);
						})
					} else {
						mui.toast('请输入密码');
					}
				}

				function save(cb) {
						var fn = $('#familyName').val().trim();
						var fin = $('#firstName').val().trim();
						var em = $('#email').val().trim();
						var nation = $('#nation').text().trim();
						var ph = $('#phone').val().trim();
						var check = $("#person_sex").prop("checked");
						var sex = (check ==true) ? '1' : '2';
						var pwd = $('#password').val().trim();
						data = {
							firstName: fin,
							familyName: fn,
							email: em,
							nation: nation,
							phone: ph,
							pwd: pwd,
							token: token,
							sex: sex
						}
						myAjax({
							url: 'account/updateSave',
							data: data
						}, function(obj) {
							if (obj.ret == 1) {
								mui.toast('保存成功');
								$('#open_apply').addClass('open_apply');
								$('.center_save').css('display', 'none');
								$('.center_edit').css('display', 'block');
								$('.edit_input').attr('disabled', 'disabled');
								$('.edit_hide').css('display', 'none');
								$('.edit_show').css('display', 'block');
								$('#nation_').removeClass('nation_');
								if (sex == 1) {
									$('.male').removeClass('mui-hidden');
									$('.female').addClass('mui-hidden');
								} else {
									$('.female').removeClass('mui-hidden');
									$('.male').addClass('mui-hidden');
								}
								var i = plus.webview.getLaunchWebview();
								mui.fire(i, 'setaccount', obj);
								setTimeout(function(){
									cb && cb();
								},300)
							} else if (obj.ret == 2) {
								mui.toast('保存失败');
							} else {
								mui.toast('服务器出现问题');
							}
						}, function(xhr, type) {
							mui.toast(xhr.status);
						})
					}
					// 弹出框属性
				var options = {
						height: 180,
						title: {
							height: 40,
							content: ""
						},
						main: {
							content: ""
						},
						buttons: [{
							name: "确定",
							click: function() {
								return true
							}
						}, {
							name: "取消",
							click: function() {
								return true;
							}
						}]
					}
					// 修改密码弹出框
				$('.center_edit').on('tap', function() {
						$(this).css('display', 'none');
						$('.center_save').css('display', 'block');
						options.height = 180;
						options.title.content = "更改提示";
						options.main.content = '<span id="nav_title"><b>Please input your password</b>' +
							'</span><div class="input_div">' +
							'<input type="password" placeholder="请输入密码" id="pop_password" maxlength="20" />' +
							'</div>';
						options.buttons[0].click = function() {
							update();
						}
						options.buttons[1].click = function() {
							$('.center_edit').css('display', 'block');
							$('.center_save').css('display', 'none');
							$('#nation_select_').css('display', 'none');
						}
						var pop = new Popup(options);
						pop.show();
					})
					// 保存
				$('.center_save').on('tap', function() {
						save(); //保存
					})
					//选择国籍
				$('.mui-table-view-cell').on('tap', '.nation_', function() {
					$('#nation_select_').css('display', 'block');
					$('.content_mask').removeClass('mui-hidden');
				})
				$('.nation_select ul li').on('tap', function() {
						var nation_name = $(this).text();
						$('#nation').text(nation_name);
						$('#nation_select_').css('display', 'none');
						$('.content_mask').addClass('mui-hidden');
					})
					//查看申请递送人信息    
				$('#open_apply').on('tap',function() {
						openWindow('../applyfor/applyPerson.html');  
					})
					//修改支付密码
				$('#wallet_pwd').on('tap', function() {
					
					options.height = 180;
					options.title.content = "输入提示";
					options.main.content = '<span id="nav_title"><b>请输入你的登录密码</b>' +
						'</span><div class="input_div">' +
						'<input type="password" placeholder="请输入密码" id="pop_password" maxlength="20" />' +
						'</div>';
					options.buttons[0].click = function() {
						update(function(){
							openWindow('../wallet/set_wallet_pwd.html');
						});
					}
					
					var pop = new Popup(options);
					pop.show();
				})
				mui.back = function() {
//					alert($('.center_save').css('display'))
					if ($('.center_save').css('display') == 'block') {
						options.height = 160;
						options.title.content = "保存";
						options.main.content = '是否需要保存';
						options.buttons[0].click = function() {
							save(function() {
								plus.webview.getLaunchWebview().show('slide-in-left', 300);
								setTimeout(function() {
									plus.webview.currentWebview().close();
								}, 1000)  
							});
						}
						var dailog = new Popup(options);
						dailog.show();  
					} else {
						plus.webview.getLaunchWebview().show('slide-in-left', 300);
						setTimeout(function() {
							plus.webview.currentWebview().close();
						}, 1000)
					}
				}
//				$('#info').on('tap',function(){
//					openWindow('new_personal_info.html')
//				})
			})
		</script>   
	</body>
</html>