<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/share_main.css" />
		<script src="../../js/mui.js"></script>
		<style>
			.trip_text{
				font-size: 14px;
				margin-bottom: 0;
				border-radius: 0;
				border: 0;
				border-bottom: 1px solid #E3E2E5;
			}
			.ul_top{
				margin-top: 52px;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav nav_header">
			<img src="../../img/left.png" class="header_left_img mui-action-back" alt="" />
			<span>Trip plan</span>
		</header>
		<div class="mui-content ">
		<div class="mui-scroll-wrapper ">
			<ul class="mui-table-view ul_top" id="dalegate">
				<li class="mui-table-view-cell">
					<div class="li_left_title">
						<span>From</span>
					</div>
					<img src="../../img/location.png" class="li_right_img" alt="" />
					<div class="li_input_s">
						<input type="text" name="" id="" value="" placeholder="from"/>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div class="li_left_title">
						<span>To</span>
					</div>
					<img src="../../img/location.png" class="li_right_img" alt="" />
					<div class="li_input_s">
						<input type="text" name="" id="" value="" placeholder="to"/>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div class="li_left_title">
						<span>By way of</span>
					</div>
					<div class="li_input_l">
						<input type="text" placeholder="way of" />
					</div>
				</li>
				<li class="mui-table-view-cell" >
					<div class="li_left_title" data-type="start" >  
						<span>Start Date</span>
					</div>
					<img src="../../img/right_.png" class="li_right_img" alt="" />
					<div class="li_input_s">
						<input type="text" name="" id="start-date" value="" placeholder="start date"/>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div class="li_left_title" data-type="end">
						<span>End date</span>
					</div>
					<img src="../../img/right_.png" class="li_right_img" alt="" />
					<div class="li_input_s">
						<input type="text" name="" id="end-date" value="" placeholder="end date"/>
					</div>
				</li>
				
			</ul>
			<textarea id="info" type="text" rows="5" cols="100%" placeholder="Please write down comment..."  class="trip_text"></textarea>
		</div>
	</div>
		<footer class="mui-bar mui-bar-footer">
			<div class="nav_footer bg_white">
				<div class="left_button" id="ok-btn">ok</div>
				<div class="right_button" id="cancel-btn">cancel</div> 
			</div>
		</footer>
	</body>
		<script src="../../js/mui.listpicker.js"></script>
		<script src="../../js/mui.dtpicker.js"></script>
	<script>
			mui.init();
			mui.plusReady(function(){
				mui(".mui-scroll-wrapper").scroll();
				var year = new Date().getFullYear();
				var options = {
					"type":"hour",
					"customData":{
						"h":[{
								"text":"上午",
								"value":"上午"
							},{
								"text":"下午",
								"value":"下午"
							},{
								"text":"晚上",
								"value":"晚上"
							}]
					},
					"labels":["年", "月", "日", "时段"],
					"beginYear" : year,
					"endYear" : year + 3
				}
//				console.log(options.endYear)
				// 选择日期
				var startdate, enddate;
				mui("#dalegate").on("tap", ".date-box", function(){
					var that = this;
					var type = that.getAttribute("data-type");
					if(type == "end"){
						var text = document.getElementById("start-date").innerText;
						if(text == "start date"){
							mui.toast("请先选择起始时间")
							return false;
						}
					}
					var picker = new mui.DtPicker(options);
					picker.show(function(rs) {
						if(type == "start"){
							that.innerHTML = rs.value;
							startdate = parseInt(rs.value.replace(/-/ig, ''));
							picker.dispose();
						} else if(type == "end"){
							var end = parseInt(rs.value.replace(/-/ig, ''));
							if(end >= startdate){
								enddate = end;
								that.innerHTML = rs.value;
							} else {
								mui.toast("时间选取错误");
							}
						}
					});
				})
				
				// 点击时触发事件
				var cpage = plus.webview.currentWebview();
				window.addEventListener("touchstart", function(event){
					var target = event.target;
					if(target.id == "ok-btn"){
						target.classList.add("btn-active");
						if(ismodified()){
							dispose();
						} else {
							mui.toast("未修改")
						}
					} else if(target.id == "cancel-btn"){
						target.classList.add("btn-active");
						setTimeout(function(){
							mui.back();
						}, 100)
					}
					// 添加按钮式响应
					var cls = target.parentNode.classList;
					if(cls.contains("icon-wrap")){
						cls.add("btn-active");
					}
				})
				
				// 点击结束时触发事件
				window.addEventListener("touchend", function(event){
					var target = event.target;
					if(target.id == "ok-btn" || target.id == "cancel-btn"){
						target.classList.remove("btn-active");
					}
					var cls = target.parentNode.classList;
					if(cls.contains("icon-wrap")){
						cls.remove("btn-active");
					}
				})
				
				var form = document.getElementById("from");
				var to = document.getElementById("to");
				var way = document.getElementById("by-way-of");
				var start = document.getElementById("start-date");
				var end = document.getElementById("end-date");
				var info = document.getElementById("info")
				
				// 判断 storage 中是否含有行程内容
				var trip = JSON.parse(plus.storage.getItem("trip-plan"));
//				console.log(plus.storage.getItem("trip-plan"));
				if(trip){
					form.value = trip.form;
					to.value = trip.to;
					way.value = trip.way;
					start.innerHTML = trip.start;
					end.innerHTML = trip.end;
					info.value = trip.info;
				}
				
				// 验证信息是否有修改
				function ismodified(){
					var flag;
					if(trip){
						flag = form.value == trip.form &&
								to.value == trip.to &&
								way.value == trip.way &&
								start.innerHTML == trip.start &&
								end.innerHTML == trip.end &&
								info.value == trip.info;
					}
					return !flag;
				}
				
				// ok-btn点击事件的处理 
				function dispose(){
					var fv = form.value.trim();
					var tv = to.value.trim();
					var wv = way.value.trim();
					var sv = start.innerHTML.trim();
					var ev = end.innerHTML.trim();
					var iv = info.value.trim();
					var obj = {
							form : fv,
							to : tv, 
							way : wv, 
							start : sv,
							end : ev,
							info : iv
						}
					if(fv && tv && wv && sv && ev && iv){
//						console.log(JSON.stringify(obj))
						plus.storage.setItem("trip-plan", JSON.stringify(obj))
						mui.toast("行程保存成功");
						setTimeout(function(){
							mui.back();
							setTimeout(function(){
								plus.webview.close(cpage, "none", 0)
							}, 300)
						}, 100)
					} else {
						mui.toast("请完善信息");
					}
				}
				
			})
		</script>
</html>
