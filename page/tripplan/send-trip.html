<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="../../css/mui.min.css" rel="stylesheet"/>
    <link href="../../css/mui.listpicker.css" rel="stylesheet" />
	<link href="../../css/mui.dtpicker.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../css/header-footer.css"/>
    <script src="../../js/mui.js"></script>
    <style type="text/css">
    	#cancel-btn {background: #fc614d;}
    	.inner-wrap {margin: 10px;border: 1px solid #ddd;}
    	.mui-table-view:after {height: 0;}
    	.mui-table-view-cell:after {left: 0;}
    	.mui-table-view-cell.fixed-padding {padding: 5px 15px;}
    	.container-item {position: relative;}
    	.icon-wrap {float: left;}
    	.icon-item {height: 35px;width: 35px;position: absolute;}
    	.icon-one {top: -2px;left: -5px;}
    	.icon-two {width: 7px;left: 9px;top: 30px;}
    	.icon-three {top: 43px;left: -5px;}
    	.container-item .item-one {border-bottom: 1px solid #ddd;}
    	.container-item .item-two {}
    	.container-item .item-one ,
    	.container-item .item-two {margin-left: 30px;}
    	.container-item .item-one input ,
    	.container-item .item-two input {margin-bottom: 0;border: none;}
    	.title-plain {margin-left: 45px;color: #666;}
    	
    	.icon-plus {top: 5px;left: 12px;}
    	.icon-item.icon-line {top: 50%;margin-top: -17px;left: 12px;}
    	
    	.fixed-textarea {padding-bottom: 0px;}
    	.textarea-wrap textarea {margin: 0;padding: 0;border: none;}
    	#trip-line {border-bottom: 1px solid #ddd;}
    	.remove-button {position: absolute;top: 50%;margin-top: -11px;right: 13px;}
    	.remove-button button {padding: 0;width: 40px;height: 21px;color: #666;}
    	.add-line {margin-left: 45px;color: #aaa;margin-right: 45px;}
    	.text-num {padding-bottom: 5px;}
    	#remain-text {padding: 0 5px;}
    	.date-box, .address-box {padding: 10px 15px;color: #aaa;}
    	#info {color: #666;}
    </style>
</head>
<body>
	
	<header class="mui-bar mui-bar-nav">
		<span class="left-back mui-pull-left">
			<img src="../../img/left.png" class="mui-action-back"></img>
		</span>
		<h1 class="mui-title mui-text-left">Trip plan</h1>
	</header>
	
	<footer class="mui-bar mui-bar-footer mui-text-center">
		<div class="button-row">
			<button id="ok-btn" class="mui-btn first-button">Ok</button>
			<button id="cancel-btn" class="mui-btn second-button">cancel</button>
		</div>
	</footer>
	
	<div class="mui-content">
		<div class="mui-scroll-wrapper">
			<div class="mui-scroll">
				<div class="inner-wrap">
					<ul class="mui-table-view">
						<!-- 选择地址 -->
						<li class="mui-table-view-cell fixed-padding">
							<div class="container-item" id="pick-address">
								<div class="icon-wrap">
									<div class="icon-item icon-one"><img src="../../img/order2.png" width="100%"/></div>
									<div class="icon-item icon-two"><img src="../../img/creat1.png" width="100%"/></div>
									<div class="icon-item icon-three"><img src="../../img/4.png" width="100%"/></div>
								</div>
								<div class="item-one">
									<div class="address-box" data-type="origin">起始地址</div>
								</div>
								<div class="item-two">
									<div class="address-box" data-type="destination">目的地址</div>
								</div>
							</div>
						</li>
						<!-- 添加途径地 -->
						<div id="trip-line">
							<li class="mui-table-view-cell lee-need-active">
								<div class="add-address">
									<div class="icon-item icon-plus"><img src="../../img/jia2.png" width="100%" height="100%"/></div>
									<div class="title-plain" id="add-wayline">添加途径地</div>
								</div>
							</li>
							<!--<li class="mui-table-view-cell">
								<div class="add-address">
									<div class="icon-item icon-line"><img src="../../img/by-the-way.png" width="100%" height="100%"/></div>
									<div class="remove-button mui-pull-right"><button class="mui-btn mui-btn-link delete-btn">删除</button></div>
									<div class="add-line">添加路径添加路径添加路径添加路径添加路径添加路径添加路径添加路径添加路径添加路径添加路径</div>
								</div>
							</li>-->
						</div>
						
						<!-- 选择日期 -->
						<li class="mui-table-view-cell fixed-padding">
							<div class="container-item" id="dalegate">
								<div class="icon-wrap">
									<div class="icon-item icon-one"><img src="../../img/time1.png" width="100%"/></div>
									<div class="icon-item icon-two"><img src="../../img/creat1.png" width="100%"/></div>
									<div class="icon-item icon-three"><img src="../../img/time5.png" width="100%"/></div>
								</div>
								<div class="item-one">
									<div class="date-box" data-type="start" id="start-date">开始时间</div>
								</div>
								<div class="item-two">
									<div class="date-box" data-type="end" id="end-date">截止日期</div>
								</div>
							</div>
						</li>
						
						<!-- 描述信息 -->
						<li class="mui-table-view-cell fixed-textarea">
							<div class="textarea-wrap">
								<textarea id="info" rows="5" placeholder="请输入描述信息" maxlength="50"></textarea>
							</div>
							<div class="text-num mui-h6 mui-text-right">
								最多输入<span id="remain-text">50</span>字
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.listpicker.js"></script>
	<script src="../../js/mui.dtpicker.js"></script>
	<script src="../../js/utils.js"></script>
	<script>
	  	mui.init();
	  	mui.ready(function(){
	  		mui(".mui-scroll-wrapper").scroll({
	  			bounce : false
	  		})
	  		
	  		// 选择起始地址与目的地址
	  		mui("#pick-address").on("tap", ".address-box", function(){
	  			var types = this.getAttribute("data-type");
	  			console.log(types)
	  			openWindow("../sendorder/pickaddr.html", {
	  				type : types
	  			});
	  		})
	  		
	  		
	  		
	  		// 添加路线
	  		var template = '<div class="add-address">'+
									'<div class="icon-item icon-line"><img src="../../img/by-the-way.png" width="100%" height="100%"/></div>'+
									'<div class="remove-button mui-pull-right"><button class="mui-btn mui-btn-link delete-btn">删除</button></div>'+
									'<div class="add-line">添加路径</div>'+
								'</div>';
			var tripline = document.getElementById("trip-line");
	  		document.getElementById("add-wayline").addEventListener("tap", function(){
	  			var oli = document.createElement("li");
	  			oli.className = "mui-table-view-cell";
	  			oli.innerHTML = template;
	  			tripline.appendChild(oli);
	  		})
	  		
	  		// 删除途径地
	  		mui("#trip-line").on("tap", ".delete-btn", function(){
	  			var parent = this.parentNode.parentNode.parentNode;
	  			parent.parentNode.removeChild(parent);
	  		})
	  		
	  		// 选择途径地
	  		var index;
	  		mui("#trip-line").on("tap", ".add-line", function(){
	  			this.classList.add("has");
		  		var all = document.querySelectorAll(".add-line");
	  			for(var i = 0; i < all.length; i++){
	  				if(all[i].classList.contains("has")){
	  					index = i;
	  					all[i].classList.remove("has");
	  					break;
	  				}
	  			}
	  			openWindow("../sendorder/pickaddr.html", {
	  				type : "tripline"
	  			});
	  		})
	  		
	  		// 触发显示途径地地址路径经纬度
	  		window.addEventListener("show:address", function(eve){
	  			var line = document.querySelectorAll(".add-line");
	  			if(eve.detail.address){
		  			line[index].setAttribute("data-address", eve.detail.address);
		  			line[index].querySelector(".add-line").innerHTML = eve.detail.address;
	  			}
	  			if(eve.detail.jd){
		  			line[index].setAttribute("data-jd", eve.detail.jd);
	  			}
	  			if(eve.detail.wd){
	  				line[index].setAttribute("data-wd", eve.detail.wd);
	  			}
	  		})
	  		
	  		// 选择时间
	  		var year = new Date().getFullYear();
			var options = {
				"type":"hour",
				"customData":{
					"h":[{
							"text":"上午",
							"value":"上午"
						},{
							"text":"下午",
							"value":"下午"
						},{
							"text":"晚上",
							"value":"晚上"
						}]
				},
				"labels":["年", "月", "日", "时段"],
				"beginYear" : year,
				"endYear" : year + 3
			}
			// 选择日期
			var startdate, enddate;
			mui("#dalegate").on("tap", ".date-box", function(){
				$('input').blur()
				$('textarea').blur();
				var that = this;
				var type = that.getAttribute("data-type");
				if(type == "end"){
					var text = document.getElementById("start-date").innerText;
					if(text == "开始时间"){
						mui.toast("请先选择起始时间")
						return false;
					}
				}
				var picker = new mui.DtPicker(options);
				picker.show(function(rs) {
					if(type == "start"){
						that.innerHTML = rs.value;
						startdate = parseInt(rs.value.replace(/-/ig, ''));
						document.getElementById("end-date").innerHTML = "截止日期";
						picker.dispose();
					} else if(type == "end"){
						var end = parseInt(rs.value.replace(/-/ig, ''));
						if(end >= startdate){
							enddate = end;
							that.innerHTML = rs.value;
						} else {
							mui.toast("时间选取错误");
						}
					}
				});
			})
			
			// 描述信息提示剩余可输入字符
			var timer;
			var last = 0;
			var remain = document.getElementById("remain-text");
			var all = parseInt(remain.innerHTML);
			document.getElementById("info").addEventListener("focus", function(){
				var that = this;
				timer = setInterval(function(){
					if(last != that.value.length){
						remain.innerHTML = all - that.value.length;
					}
					last = that.value.length;
				}, 300)
			})
			document.getElementById("info").addEventListener("blur", function(){
				clearInterval(timer);
			})
			
	  	})
	</script>
</body>
</html>