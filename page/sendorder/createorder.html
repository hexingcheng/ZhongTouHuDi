<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<title></title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="common.css" />
		<link rel="stylesheet" href="../../css/common/popup.css"/>
		<script src="../../js/common/popup.js"></script>
		<script src="../../js/mui.min.js"></script>
		<style>
			* {
				padding: 0;
				margin: 0;
			}
			html,
			body,
			.mui-content,
			#offCanvasSideScroll,
			.order-content {
				height: 100%;
				width: 100%;
			}
			.order-content {
				padding: 5px;
				background-color: #ededeb;
			}
			.draft {
				color: #FFFFFF;
			}
			@font-face {
				font-family: "iconfont";
				src: url('../../icon/iconfont.eot');
				/* IE9*/
				
				src: url('../../icon/iconfont.eot?#iefix') format('embedded-opentype'),
				/* IE6-IE8 */
				
				url('../../icon/iconfont.woff') format('woff'),
				/* chrome、firefox */
				
				url('../../icon/iconfont.ttf') format('truetype'),
				/* chrome、firefox、opera、Safari, Android, iOS 4.2+*/
				
				url('../../icon/iconfont.svg#iconfont') format('svg');
				/* iOS 4.1- */
			}
			.iconfont {
				font-family: "iconfont" !important;
				font-size: 16px;
				font-style: normal;
				-webkit-font-smoothing: antialiased;
				-webkit-text-stroke-width: 0.2px;
				-moz-osx-font-smoothing: grayscale;
			}
			.icon-wenjian:before {
				content: "\e600";
			}
			.fl {
				float: left;
			}
			.fr {
				float: right;
			}
			.clear {
				zoom: 1;
			}
			.clear:after {
				content: "";
				display: block;
				clear: both;
			}
			.wid30 {
				width: 50px;
			}
			.wid70 {
				overflow: hidden;
			}
			.paddl10 {
				padding-left: 10px;
			}
			.paddr10 {
				padding-right: 10px;
			}
			.hei110 {
				height: 50px;
			}
			.linehei110 {
				line-height: 50px;
			}
			.linehei68 {
				line-height: 34px;
			}
			.iptwrap {
				padding: 0;
				margin: 8px 0 8px 0px;
				height: 34px;
			}
			.iptwrap input {
				font-size: 16px;
				border: 0;
				color: #5d5d5d;
				margin: 0;
				height: 30px;
				margin: 2px 0;
				padding: 0;
				line-height: 1;
			}
			.colorgray {
				color: #5f5d5d;
			}
			.colorg {
				color: #bec0c2;
			}
			.gap {
				height: 10px;
				background-color: #F2F2F2;
			}
			#border-none {
				background-color: #FFFFFF;
			}
			.wid20 {
				width: 50px;
			}
			.wid50 {
				overflow: hidden;
			}
			.gWeight,
			.gValue {
				background-color: #FFFFFF;
				border-bottom: 1px solid #E8E8E8;
			}
			.fr {
				color: #a1a1a1;
			}
			.addborder {
				border-left: 1px solid #e8e8e8;
			}
			.wid40 {
				width: 40%;
			}
			.goods-pic,
			.addclass {
				background-color: #FFFFFF;
			}
			.goods-pic {
				width: 100%;
				padding: 15px 20px
			}
			input[type=number] {
				padding: 0 15px;
			}
			.mui-input-row .mui-input-clear~.mui-icon-clear {
				top: 5px;
			}
			.hidden {
				width: 0;
				height: 0;
			}
			.pos {
				position: absolute;
				right: -8px;
				color: #3ba767;
			}
			.persee-con {
				width: 100%;
				height: 100%;
				position: absolute;
				z-index: 1000;
				top: 0;
				left: 0;
			}
			.handle {
				position: absolute;
				right: 10px;
				bottom: 10px;
			}
			.handle span {
				color: #FFFFFF;
			}
			.num {
				position: absolute;
				bottom: 10px;
				left: 45%;
				color: #FFFFFF;
			}
			.hidden {
				display: none;
			}
			.presee,
			.backmask {
				width: 100%;
				height: 100%;
				z-index: 30;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
			}
			.presee {
				position: fixed;
				background-color: rgba(0, 0, 0, 1);
			}
			.backmask {
				position: fixed;
				background-color: rgba(0, 0, 0, .5);
			}
			.picwraps {
				position: absolute;
				width: 100%;
				height: 100%;
			}
			.bars {
				position: absolute;
				right: 10px;
				bottom: 10px;
				color: #FFFFFF;
			}
			.presee .mui-slider {
				width: 80%;
				height: 100%;
				margin: 0 auto;
				overflow: hidden;
			}
			.presee .mui-slider .mui-slider-item {
				padding: 0 10px;
				height: 100%;
				box-sizing: border-box;
			}
			.presee .mui-slider .mui-slider-item a {
				height: 100%;
				position: relative;
			}
			.presee .mui-slider .mui-slider-item a img {
				position: absolute;
			}
			div.mui-scroll-wrapper {
				top: 52px;
				bottom: 64px;
			}
			.myicon {
				display: block;
				width: 34px;
				height: 34px;
				margin: 8px;
			}
			.myicon img {
				height: 34px;
				width: 34px;
			}
			#gname {
				padding-right: 15px;
			}
			.font-14 {
				font-size: 16px;
			}
			.addpad {
				padding-left: 15px;
			}
			.addline {
				font-size: 16px;
				line-height: 34px;
				color: #acacac;
			}
			#head {
				padding-right: 0px;
			}
			.goods-pic .mui-table-view {
				width: 100%;
				background-color: #FFFFFF;
			}
			.goods-pic .mui-table-view:before,
			.mui-table-view:after {
				height: 0;
			}
			.goods-pic .mui-table-view .mui-table-view-cell {
				float: left;
				padding: 0 !important;
				width: 23.5%;
			}
			.addmarr {
				margin-right: 2%;
			}
			.goods-pic .mui-table-view,
			.mui-table-view-cell:after {
				height: 0;
			}
			.goods-pic .mui-table-view .mui-table-view-cell a {
				width: 100%;
				height: 100%;
				margin: 0!important;
			}
			.goods-pic .mui-table-view .mui-table-view-cell a span {
				font-size: 24px;
				color: #D1D1D1;
				text-align: center;
				height: 100%;
				width: 100%;
			}
			.addclass {
				border: 1px solid #D1D1D1;
			}
			#take-photo {
				padding: 0;
			}
			.clear {
				zoom: 1;
			}
			.clear:after {
				content: "";
				display: block;
				clear: both;
			}
			.borleft {
				border-left: 1px solid #D1D1D1;
			}
			.pictips {
				padding: 0 15px;
				word-break: break-all;
				color: #acacac;
				font-size: 16px;
			}
			.gName .info {
				background-color: #FFFFFF;
			}
			.cancel {
				float: left;
				height: 40px;
				width: 50%;
				line-height: 40px;
				background-color: #f6ccc2;
				text-align: center;
				color: #da2a02;
			}
			.ok {
				float: left;
				height: 40px;
				width: 50%;
				line-height: 40px;
				background-color: #c4e8da;
				text-align: center;
				color: #029c5d;
			}
			.wron {
				padding: 0 20px;
			}
			.draftinfo {
				color: #000000;
				padding: 10px 20px;
			}
			.backhandle {
				background-color: #FFFFFF;
				position: absolute;
				top: 60px;
				left: 0;
				width: 270px;
				overflow: hidden;
				word-break: break-all;
			}
			#gweight {
				padding: 0;
			}
			#gvalue {
				padding: 0;
			}
			
			#take-photo img {
				width: 100%;
				height: 100%;
			}
			.loading-mask {
				position: absolute;
				left: 0;
				top: 52px;
				bottom: 0;
				right: 0;
				z-index: 998;
				background: rgba(255, 255, 255, 1);
			}
			.loading-mask .loading-img {
				width: 80px;
				height: 80px;
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -40px;
				margin-top: -40px;
			}
			.loading-mask .loading-img img {
				width: 100%;
				height: 100%;
			}
			.rechoosepic{
				position: absolute;
				right: 0;
			}
			.mui-bar-footer~.mui-content{
				padding-bottom: 64px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav nav_header">
			<img src="../../img/left.png" class="mui-action-back header_left_img" alt="" />
			<img src="../../img/draft.png" class="header_right_img draft" alt="" id="drafticon" />
			<span>创建订单</span>
		</header>
		<footer class="mui-bar mui-bar-footer">
			<button class="mui-btn nav_footer" id="next">
				<span>Next Step</span>
			</button>
		</footer>

		<div class="loading-mask mui-hidden">
			<div class="loading-img">
				<img src="../../img/loading2.gif" />
			</div>
		</div>

		<div class="presee mui-hidden">
			<div class="picwraps">
				<div class="mui-slider" id="slider">
					<div class="mui-slider-group" id="preseepic">
						<div class="mui-slider-item">
							<a href="javascript:void(0)">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="javascript:void(0)">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="javascript:void(0)">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="javascript:void(0)">
								<img src="" class="preimg">
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="rechoosepic">
				<img src="../../img/contact.png"/>
			</div>
		</div>
		
		<!--<div class="backmask mui-hidden">
			<div class="backhandle mui-hidden">
				<div class="draftinfo">
					Do you want to add this order to draft?
				</div>
				<p class="wron">you can use draft orde r to resend</p>
				<div class="ok">ok</div>
				<div class="cancel">cancel</div>
			</div>
		</div>-->
		
		<div id="delete" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a class="bycamera" data-type="camera">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a class="bygallery" data-type="gallery">相册</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#delete"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<div id="handle" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a>确认</a>
				</li>
				<li class="mui-table-view-cell">
					<a>重新选择</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#handle"><b>返回</b></a>
				</li>
			</ul>
		</div>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="order-content clear">
						<div class="gName clear hei110" style="background: #FFFFFF;">
							<div class="wid30 fl hei110 linehei110 colorg">
								<span class="colorgray myicon"><img src="../../img/weight.png"></span>
							</div>
							<div class="wid70 paddr10 hei110">
								<div class="iptwrap mui-input-row">
									<input type="text" class="linehei68 mui-input-clear" id="gname" placeholder="Name" />
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="gWeight clear">
							<div class="wid30 fl hei110 linehei110 colorg">
								<span class="colorgray myicon"><img src="../../img/weight.png"></span>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center borleft" id="change-w">
								<span class="kg-g font-14">Kg</span>
							</div>
							<div class="wid50 hei110">
								<div class="iptwrap mui-input-row">
									<input type="text" class="linehei68 mui-input-clear" id="gweight" placeholder="Weight" />
								</div>
							</div>
						</div>
						<div class="gValue clear">
							<div class="wid30 fl hei110 linehei110 colorg">
								<span class="colorgray myicon"><img src="../../img/value.png"></span>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center borleft" id="change-w">
								<span class="kg-g font-14">$</span>
							</div>
							<div class="wid50 hei110">
								<div class="iptwrap mui-input-row">
									<input type="text" class="linehei68 mui-input-clear" id="gvalue" placeholder="Value" />
								</div>
							</div>
						</div>
						<div class="info clear" id="info" style="background: #FFFFFF;">
							<div class="wid30 fl hei110 linehei110 colorg">
								<span class="colorgray myicon"><img src="../../img/coment.png"></span>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center" id="change-w">
								<span class="kg-g font-14 myicon"><img src="../../img/enter.png"></span>
							</div>
							<div class="wid50 hei110">
								<div class="iptwrap mui-input-row  addline" id="gettext">
									Comment
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="goods-pic">
							<ul class="mui-table-view clear" id="take-photo">
								<li class="mui-table-view-cell img-box addmarr" data-index='0'>
									<a href="#delete" class="picpre pic-img">
										<span class="mui-icon mui-icon-plusempty addclass"></span>
										<!--<span class="wids"><img src="../../img/2147de349744915c611f470c84c67f94.jpg" width="100%" height="100%"></span>-->
									</a>
								</li>
								<li class="mui-table-view-cell img-box addmarr" data-index='1'>
									<a href="#delete" class="picpre pic-img">
										<span class="mui-icon mui-icon-plusempty addclass"></span>
									</a>
								</li>
								<li class="mui-table-view-cell img-box addmarr" data-index='2'>
									<a href="#delete" class="picpre pic-img">
										<span class="mui-icon mui-icon-plusempty addclass"></span>
									</a>
								</li>
								<li class="mui-table-view-cell img-box" data-index='3'>
									<a href="#delete" class="picpre pic-img">
										<span class="mui-icon mui-icon-plusempty addclass"></span>
									</a>
								</li>
							</ul>
						</div>
						<div class="pictips" style="background: #FFFFFF;">! please add goods picture to make the order more detail</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script type="text/javascript" src="../../js/utils.js"></script>
	<script type="text/javascript" charset="utf-8">
		mui.init();
		var getdata = {};
		getdata.gName = "";
		getdata.gWeight = "";
		getdata.gValue = "";
		getdata.pics = "";
		getdata.info = "";
		var picindex = 0;
		function layout() {
			var h = $('.picpre').width();
			$('.picpre').height(h);
			$('#take-photo').height(h);
			$('.addclass').css('line-height', h + 'px')
		}
		layout();
		mui.plusReady(function() {
			mui(".mui-scroll-wrapper").scroll(); 
			plus.webview.currentWebview().setStyle({
				scrollIndicator: "none"
			})
			document.querySelector('.mui-slider').addEventListener('slide', function(event) {
				picindex = event.detail.slideNumber;
			})
			
			// 重量与价值
			fixedNum("#gweight");
			fixedNum("#gvalue");
			
			$('.rechoosepic').on('tap',function(e){
				var src = $('.mui-slider-item').eq(picindex).find('img').attr('src');
				$('.mui-slider-item').eq(picindex).remove();
				var str = '<a href="#delete" class="picpre pic-img"><span class="mui-icon mui-icon-plusempty addclass"></span></a>'
				var wid = $('.mui-table-view-cell','#take-photo').eq(picindex).width();
				$('.mui-table-view-cell','#take-photo').eq(picindex).html(str).css({
					"height":wid
				}).find('span').css({
					'line-height':wid+'px'
				});
				if(!$('.mui-slider-item').length){
					$('.presee').addClass('mui-hidden');
				}
				return false;
			})
			document.getElementById('info').addEventListener('tap', function() {
				var param = {};
				if ($(this).text() != 'Comment') {
					var texts = $(this).text();
					if (texts.lastIndexOf('(') != -1) {
						var n = texts.lastIndexOf('(');
						var ipt = texts.substring(0, n);
						var choose = texts.substring(n);
						param.ipt = ipt;
						param.choose = choose;
					} else {
						param.ipt = ipt;
					}
				}
				openWindow('./comment.html', param);
			})
			document.getElementById('next').addEventListener('tap', function() {
					var name = $.trim($("#gname").val());
					var weight = parseInt($.trim($("#gweight").val()));
					var value = parseInt($.trim($("#gvalue").val()));
					var info = $.trim($('#gettext').text());
					if (validate()) { // 验证成功
						$("#next").attr("disabled", true);
						$("#next").html("next...");
						var param = {
							gName: name,
							gWeight: weight,
							gValue: value,
							info: info
						}
						if (!setpicid()) {
							param.pics = "";
						} else {
							param.pics = setpicid();
						}
						var draft = JSON.parse(plus.storage.getItem("draft-datas"));
						if (draft && draft.res && draft.res.orderId) {
							param.orderId = draft.res.orderId;
						}
						openNewWindow('./create-next.html', param)
					} else {
						mui.toast("name is unkown");
					}
				})
			

			function toverticalcenter() {
				var item = $('.preimg')
				var len = item.length;
				for (var i = 0; i < len; i++) {
					var t = ($(window).height() - item.eq(i).height()) / 2
					item.eq(i).css('top', t)
				}
			}

			function validate() {
				var flag = false;
				var gname = $.trim($("#gname").val());
				if (gname) {
					flag = true;
				}
				return flag;
			}
			window.addEventListener('getinfo', function(eve) {
				$('#gettext').text(eve.detail.info).css('color', '#5d5d5d');
			})
			var iw, _this;
			mui('#take-photo').on('tap', '.addclass', function(e) {
				iw = $(this).outerWidth()
				_this = this;
			})
			$('.presee').on('tap', function() {
				$(this).addClass('mui-hidden')
			})
			var type = null;
			$('.bycamera').on('tap', function() {
				bycamera(_this)
				mui('#delete').popover('toggle')
				$(".loading-mask").removeClass("mui-hidden");
			})
			$('.bygallery').on('tap', function() {
				bygallery(_this);
				mui('#delete').popover('toggle')
				$(".loading-mask").removeClass("mui-hidden");
			})
			$('.draft').on('tap', function() {
				openWindow('./draft.html')
			})
			
			// 取消订单弹出框
			var options = {
				height : 190,
				addmaskevent : true,
				title : {
					height : 45,
					content : ""
				},
				main : {
					content : ""
				},
				buttons : [{
					name : "OK",
					click : function(){ return true }
				},{
					name : "cancel",
					click : function(){ return true; }
				}]
			}
			
			//  返回按钮处理
			var pop;
			mui.back = function() {
				var cls = document.querySelector(".presee").classList;
				var leemask = document.getElementById("lee-mask");			// 判断当前蒙层是否存在
				var leecontent = document.getElementById("lee-content");		
				if (cls.contains("mui-hidden")) {
					if ($('#gname').val()) {
						if(!leecontent && !leemask) {			// 如果当前不存在弹出框，执行弹出框效果
							getdata.gName = $('#gname').val();
							getdata.gWeight = $('#gweight').val() || 0;
							getdata.gValue = $('#gvalue').val() || 0;
							getdata.info = $('#gettext').val() || "";
							getdata.pics = setpicid()
							getdata.status = 0;
							
							plus.storage.removeItem("draft-datas");
							
							options.height = 160;
							options.title.content = "提示";
							options.main.content = 'you can use draft orde r to resend';
							options.buttons[0].click = function(){
								myAjax({
									url: 'order/resOrderByGood',
									data: getdata
								}, function() {
									openNewWindow("./draft.html");
									mui.toast('保存草稿成功！');
								}, function(xhr, type) {
									mui.toast('出错了' + type)
								})
							}
							options.buttons[1].click = function(){
								plus.webview.getLaunchWebview().show('slide-in-left', 300);
								closewebview();
							}
							pop = new Popup(options);
							pop.show();
						} else {			// 如果没有弹出框，就隐藏该弹出框效果
							pop.hide(document.getElementById("lee-mask"), document.getElementById("lee-content"));
						}
					} else {
						plus.webview.getLaunchWebview().show('slide-in-left');
						closewebview()
					}
				} else {
					cls.add("mui-hidden")
				}
			}

			function closewebview() {
				if (plus.webview.getWebviewById('sendorder/createorder')) {
					plus.webview.getWebviewById('sendorder/createorder').close("slide-out-right",300)
				}
				if (plus.webview.getWebviewById('create-next')) {
					plus.webview.getWebviewById('create-next').close("slide-out-right",300);
				}
				if (plus.webview.getWebviewById('pickaddr')) {
					plus.webview.getWebviewById('pickaddr').close("slide-out-right",300);
				}
				if (plus.webview.getWebviewById('chooseaddr')) {
					plus.webview.getWebviewById('chooseaddr').close("slide-out-right",300);
				}
				if (plus.webview.getWebviewById('draft')) {
					plus.webview.getWebviewById('draft').close("slide-out-right",300)
				}
			}

			function bycamera(contexts) {
				$(contexts).parent().attr('href', "#");
				var camera = plus.camera.getCamera();
				var res = camera.supportedImageResolutions[0];
				var fmt = camera.supportedImageFormats[0];
				camera.captureImage(function(path) {
					dealpic(path, contexts)
				}, function() {
					$(contexts).parent().attr('href', "#delete");
					$(".loading-mask").addClass("mui-hidden");
				})
			}

			function dealpic(path, contexts) {
				plus.io.resolveLocalFileSystemURL(path, function(entry) {
					var local = entry.toLocalURL();
					dealImage(local, {
						width: 17 * 4,
						quality: 0.5
					}, function(base) {
						$(contexts).removeClass('mui-icon-plusempty mui-icon addclass').addClass('mui-spinner')
						console.log("压缩后：" + base.length * 0.8 / 1024 + "KB");
						sendData("common/file/imgUp", base, contexts, local);
					})
				})
			}

			function bygallery(context) {
					//				$(context).parent().attr('href', "#");
					plus.gallery.pick(function(eve) {
						for (var i = 0, len = eve.files.length; i < len; i++) {
							(function(i, len) {
								plus.io.resolveLocalFileSystemURL(eve.files[i], function(entry) {
									var local = entry.toLocalURL(); // 获取本地地址
									// 图片压缩处理
									dealImage(local, {
//											width: 17 * 4,
											quality: 1
										},
										function(base) {
											var obj = {
												path: local,
												base: base
											}
											sendImgData(obj)
										})
								})
							})(i, len)
						}
					}, function(e) {
						$(context).parent().attr('href', "#delete");
						$(".loading-mask").addClass("mui-hidden");
					}, {
						filter: 'image',
						multiple: true
					})
				}
				// 多张选择照片上传

			function sendImgData(datas) {
					myAjax({
						url: "common/file/imgUp",
						data: {
							imgName: Math.floor(Math.random() * 1000) + "" + (new Date().getTime()) + ".jpg",
							imgData: datas.base, // base字符串
							dataLength: datas.base.length // base字符串长度
						},
						wait: false
					}, function(data) {
						var img = '<span class="wids"><img title=' + datas.path + ' src=' + datas.path + ' alt=' + data.res.fid + '></span>';
						var picimg = $("#take-photo").find(".pic-img")
						for (var i = 0; i < picimg.size(); i++) {
							if (picimg.eq(i).find("img").size() == 0) {
								picimg.eq(i).html(img);
								picimg.eq(i).attr("href", "javascript:void(0);")
								break;
							}
						}
						setTimeout(function() {
							$(".loading-mask").addClass("mui-hidden");
						}, 500)
						$('img', '.wids').css({
							width: iw,
							height: iw
						})
					}, function(xhr, type) {
						console.log("错误信息显示：" + type);
						$(".loading-mask").addClass("mui-hidden");
						errorhandle(type);
					})
				}
				// 照相获取图片上传
			function sendData(urls, base, context, path) {
				var pics
				myAjax({
					url: urls,
					data: {
						imgName: Math.floor(Math.random() * 1000) + "" + (new Date().getTime()) + ".jpg",
						imgData: base, // base字符串
						dataLength: base.length // base字符串长度
					},
					wait: false
				}, function(data) {
					var img = $('<span class="wids"><img title=' + path + ' src=' + base + ' alt=' + data.res.fid + '></span>');
					$(context).parent().append(img);
					$('img', '.wids').css({
						width: iw,
						height: iw
					})
					$(context).remove();
					setTimeout(function() {
						$(".loading-mask").addClass("mui-hidden");
					}, 50)
				}, function(xhr, type) {
					console.log("错误信息显示：" + type);
					errorhandle(type);
				})
			}

			function setpicid() {
				var pics = [];
				var num = $('#take-photo').find(".wids").length;
				for (var i = 0; i < num; i++) {
					pics[i] = $('img', $('#take-photo').find(".wids").eq(i)).attr('alt');
				}
				return pics.join(',');
			}
			mui('.mui-table-view-cell').on('tap', '.wids', function() {
				var ind = $(this).parents('.mui-table-view-cell').attr('data-index');
				var num = $('.mui-slider-item', '#preseepic').length;
				var inner = "";
				for (var k = 0; k < 4; k++) {
					inner += '<div class="mui-slider-item"><a href="javascript:void(0)"><img src="" class="preimg"></a></div>';
				}
				$('.presee').removeClass('mui-hidden');
				$('#preseepic').html(inner)
				var haspic = $('.picpre');
				var removeArr = [];
				for (var i = 0; i < 4; i++) {
					$('.mui-slider-item', '#preseepic').attr('data-index', i);
					if (Boolean($('span', haspic.eq(i)).hasClass('wids'))) {
						var path = $('img', haspic.eq(i)).attr('title');
						$('.preimg', '#preseepic').eq(i).attr('src', path)
					} else {
						removeArr.push(i)
					}
				}
				for (var j = removeArr.length; j > 0; j--) {
					$('.mui-slider-item', '#preseepic').eq(removeArr[j - 1]).remove();
				}
				toverticalcenter();
				var gallery = mui('#slider');
				gallery.slider({
					interval: 0
				}).gotoItem(ind);
				
			})

			function dealImage(path, obj, callback) {
				var img = new Image();
				img.src = path;
				img.onload = function() {
					var that = this;
					// 默认按比例压缩
					var w = that.width,
						h = that.height,
						scale = w / h;
					w = obj.width || w;
					h = obj.height || (w / scale);
					var quality = 0.7; // 默认图片质量为0.7
					//生成canvas
					var canvas = document.createElement('canvas');
					var ctx = canvas.getContext('2d');
					// 创建属性节点
					var anw = document.createAttribute("width");
					anw.nodeValue = w;
					var anh = document.createAttribute("height");
					anh.nodeValue = h;
					canvas.setAttributeNode(anw);
					canvas.setAttributeNode(anh);
					ctx.drawImage(that, 0, 0, w, h);
					// 图像质量
					if (obj.quality && obj.quality <= 1 && obj.quality > 0) {
						quality = obj.quality;
					}
					// quality值越小，所绘制出的图像越模糊
					var base64 = canvas.toDataURL('image/jpeg', quality);
					// 回调函数返回base64的值
					callback(base64);
				}
			}
			window.addEventListener('getdraftdata', function(eve) {
				var datas = eve.detail.formdatas;
				showobj(datas);
			})
			window.addEventListener('getdraft', function(eve) {
				$("#next").attr("disabled", false);
				$("#next").html("Next Step");
				getdata = eve.detail;
			})
			var cpage = plus.webview.currentWebview();
			if (cpage.type == "cancel") {
				refreshdata();
			}
			window.addEventListener("draft:datas", function(eve) {
				refreshdata();
			})
			// 重新刷新数据显示
			function refreshdata() {
				var iw = $('.addmarr').outerWidth()
				var datas = JSON.parse(plus.storage.getItem("draft-datas"));
				console.log(plus.storage.getItem("draft-datas"));
				$("#gname").val(datas.res.gName); // 商品名
				$("#gweight").val(datas.res.gWeight);
				$("#gvalue").val(datas.res.gValue);
				$("#gettext").val(datas.res.info);
				getdata.orderId = datas.res.orderId; // 该商品ID
				var html = "<a href='#delete' class='picpre pic-img'><span class='mui-icon mui-icon-plusempty addclass' style='height: " + iw + "px;line-height:" + iw + "px'></span></a>";
				$(".img-box").html(html);
				if (datas.res.pics.length > 0) {
					var n = BASEURL.indexOf('/api/');
					var per = BASEURL.substring(0, n);
					var pic = datas.res.pics;
					var len = pic.length;
					console.log(JSON.stringify(pic));
					if (len > 0) {
						for (var i = 0; i < len; i++) {
							var url = per + pic[i].minPath;
							var html = '<a  href="#" class="picpre pic-img"><span class="wids"><img alt="' + pic[i].id + '" title="' + url + '" style="height: ' + iw + 'px" src=' + url + '></span></a>';
							document.querySelectorAll(".img-box")[i].innerHTML = html;
						}
					}
				}
			}
			
		})
	</script>

</html>