<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<title></title>
		<script src="../../js/mui.min.js"></script>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<style>
			* {
				padding: 0;
				margin: 0;
			}
			html,
			body {
				height: 100%;
				width: 100%;
			}
			html,
			body,
			.mui-content {
				background-color: #FFFFFF;
			}
			.mui-bar {
				background-color: #3ba767;
			}
			.mui-bar h1,
			.mui-bar a {
				color: #FFFFFF;
			}
			.draft {
				color: #FFFFFF;
			}
			@font-face {
				font-family: "iconfont";
				src: url('../../icon/iconfont.eot');
				/* IE9*/
				
				src: url('../../icon/iconfont.eot?#iefix') format('embedded-opentype'),
				/* IE6-IE8 */
				
				url('../../icon/iconfont.woff') format('woff'),
				/* chrome、firefox */
				
				url('../../icon/iconfont.ttf') format('truetype'),
				/* chrome、firefox、opera、Safari, Android, iOS 4.2+*/
				
				url('../../icon/iconfont.svg#iconfont') format('svg');
				/* iOS 4.1- */
			}
			.iconfont {
				font-family: "iconfont" !important;
				font-size: 16px;
				font-style: normal;
				-webkit-font-smoothing: antialiased;
				-webkit-text-stroke-width: 0.2px;
				-moz-osx-font-smoothing: grayscale;
			}
			.icon-wenjian:before {
				content: "\e600";
			}
			.mui-scroll-wrapper {
				margin-top: 44px;
				margin-bottom: 60px;
			}
			.fl {
				float: left;
			}
			.fr {
				float: right;
			}
			.clear {
				zoom: 1;
			}
			.clear:after {
				content: "";
				display: block;
				clear: both;
			}
			.wid30 {
				width: 30%;
			}
			.wid70 {
				width: 70%;
			}
			.paddl10 {
				padding-left: 10px;
			}
			.paddr10 {
				padding-right: 10px;
			}
			.hei110 {
				height: 60px;
			}
			.linehei110 {
				line-height: 60px;
			}
			.linehei68 {
				line-height: 30px;
			}
			.iptwrap {
				padding: 0;
				margin: 15px 0;
				height: 30px;
				border-radius: 10px;
			}
			.iptwrap input {
				border: 0;
				background-color: #F7F5F5;
				color: #219B52;
				margin: 0;
				height: 30px
			}
			.colorgray {
				color: #5f5d5d;
			}
			.colorg {
				color: #bec0c2;
			}
			.gap {
				height: 10px;
				background-color: #F2F2F2;
			}
			#border-none {
				background-color: #FFFFFF;
			}
			.wid20 {
				width: 20%;
			}
			.wid50 {
				width: 50%;
			}
			.gWeight,
			.gValue {
				border-bottom: 1px solid #E8E8E8;
			}
			.fr {
				color: #a1a1a1;
			}
			.addborder {
				border-left: 1px solid #e8e8e8;
			}
			.wid40 {
				width: 40%;
			}
			.goods-pic,
			.addclass {
				border: 1px solid #e6e1e1;
				padding: 15px;
				background-color: #fdfcfc;
			}
			#footer {
				height: 60px;
				background-color: #FFFFFF;
				padding: 10px 20px;
			}
			.next-step {
				text-align: center;
				background-color: #3ba767;
				width: 100%;
				height: 100%;
				line-height: 40px;
				color: #ceefe4;
			}
			input[type=number] {
				padding: 0 15px;
			}
			.mui-input-row .mui-input-clear~.mui-icon-clear {
				top: 5px;
			}
			.hidden {
				width: 0;
				height: 0;
			}
			.pos {
				position: absolute;
				right: -8px;
				color: #3ba767;
			}
			.persee {
				width: 100%;
				height: 100%;
				position: absolute;
				z-index: 1000;
				top: 0;
				left: 0;
				background-color: #000000;
			}
			.persee-con {
				width: 100%;
				height: 100%;
				position: absolute;
				z-index: 1000;
				top: 0;
				left: 0;
			}
			.handle {
				position: absolute;
				right: 10px;
				bottom: 10px;
			}
			.handle span {
				color: #FFFFFF;
			}
			.num {
				position: absolute;
				bottom: 10px;
				left: 45%;
				color: #FFFFFF;
			}
			.hidden {
				display: none;
			}
			.presee {
				width: 100%;
				height: 100%;
				position: absolute;
				z-index: 30;
				background-color: rgba(0, 0, 0, 1);
			}
			.picwraps {
				position: absolute;
				width: 100%;
				height: 100%;
			}
			.bars {
				position: absolute;
				right: 10px;
				bottom: 10px;
				color: #FFFFFF;
			}
			.presee .mui-slider {
				width: 80%;
				max-height: 70%;
				margin: 30% auto 40%;
				overflow: hidden;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">create order</h1>
			<span class="mui-icon iconfont icon-wenjian mui-pull-right draft"></span>
		</header>
		<footer class="mui-bar mui-bar-footer" id="footer">
			<div class="next-step" id="next">Next Step</div>
		</footer>
		<div class="presee mui-hidden">
			<div class="picwraps">
				<div class="mui-slider" id="slider">
					<div class="mui-slider-group" id="preseepic">
						<div class="mui-slider-item">
							<a href="#">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="#">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="#">
								<img src="" class="preimg">
							</a>
						</div>
						<div class="mui-slider-item">
							<a href="#">
								<img src="" class="preimg">
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="mui-icon mui-icon-bars bars"></div>
		</div>
		<div id="delete" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#" class="bycamera">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#" class="bygallery">相册</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#delete"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<div class="mui-content">
			<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="order-content">
						<div class="gName clear hei110">
							<div class="wid30 paddl10 fl hei110 linehei110 colorg">
								<span class="mui-icon mui-icon-person colorgray"></span> Name
							</div>
							<div class="wid70 paddr10 fl hei110">
								<div class="iptwrap mui-input-row">
									<input type="text" class="linehei68 mui-input-clear" id="gname" />
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="gWeight clear">
							<div class="wid30 paddl10 fl hei110 linehei110 colorg">
								<span class="mui-icon mui-icon-person colorgray"></span> Weight
							</div>
							<div class="wid50 paddr10 fl hei110">
								<div class="iptwrap mui-input-row">
									<input type="number" class="linehei68 mui-input-clear" id="gweight" />
								</div>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center" id="change-w">
								<span class="kg-g">Kg</span>
							</div>
						</div>
						<div class="gValue clear">
							<div class="wid30 paddl10 fl hei110 linehei110 colorg">
								<span class="mui-icon mui-icon-person colorgray"></span> Value
							</div>
							<div class="wid50 paddr10 fl hei110">
								<div class="iptwrap mui-input-row">
									<input type="number" class="linehei68 mui-input-clear" id="gvalue" />
								</div>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center">$
							</div>
						</div>
						<div class="info clear" id="info">
							<div class="wid40 paddl10 fl hei110 linehei110 colorg">
								<span class="mui-icon mui-icon-person colorgray"></span> Comment
							</div>
							<div class="wid40 paddr10 fl hei110">
								<div class="iptwrap mui-input-row">
									<input type="text" class="linehei68 mui-input-clear" id="gettext" />
								</div>
							</div>
							<div class="fr hei110 linehei110 wid20 mui-text-center">
								<span class="mui-icon mui-icon-arrowright"></span>
							</div>
						</div>
						<div class="gap"></div>
						<div class="goods-pic">
							<ul class="mui-table-view mui-grid-view" id="take-photo">
								<li class="mui-table-view-cell mui-media mui-col-xs-3 img-box">
									<a href="#delete" class="picpre">
										<span class="mui-icon mui-icon-plusempty addclass 1"></span>
									</a>
								</li>
								<li class="mui-table-view-cell mui-media mui-col-xs-3 img-box">
									<a href="#delete" class="picpre">
										<span class="mui-icon mui-icon-plusempty addclass 2"></span>
									</a>
								</li>
								<li class="mui-table-view-cell mui-media mui-col-xs-3 img-box">
									<a href="#delete" class="picpre">
										<span class="mui-icon mui-icon-plusempty addclass 3"></span>
									</a>
								</li>
								<li class="mui-table-view-cell mui-media mui-col-xs-3 img-box">
									<a href="#delete" class="picpre">
										<span class="mui-icon mui-icon-plusempty addclass 4"></span>
									</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../js/utils.js"></script>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script type="text/javascript" charset="utf-8">
		mui.init();
		var getdata = {};
				getdata.gName="";
				getdata.gWeight= "";
				getdata.gValue= "";
				getdata.pics= "";
				getdata.info= "";
				
				
		mui.plusReady(function() {
			mui('#offCanvasSideScroll').scroll();
			plus.webview.currentWebview().setStyle({
				scrollIndicator: "none"
			})
			document.getElementById('info').addEventListener('tap', function() {
				openWindow('./comment.html');
			})
			document.getElementById('next').addEventListener('tap', function() {
				var name = $.trim($("#gname").val());
				var weight = parseInt($.trim($("#gweight").val()));
				var value = parseInt($.trim($("#gvalue").val()));
				var info = $.trim($('#gettext').val());
				
				if(validate()){		// 验证成功
					var param = {
						gName: name,
						gWeight: weight,
						gValue: value,
						info: info
					}
					if(!setpicid()){
						param.pics = "";
					} else {
						param.pics = setpicid();
					}
					var draft = JSON.parse(plus.storage.getItem("draft-datas"));
					if(draft && draft.res && draft.res.orderId){
						param.orderId = draft.res.orderId;
					}
					
					openNewWindow('./create-next.html', param) 
				} else {
					mui.toast("资料填写不完整");
				}
			})
			
			// 信息验证
			function validate(){
				var flag = false;
				var gname = $.trim($("#gname").val());
				var gweight = $.trim($("#gweight").val());
				var gvalue = $.trim($("#gvalue").val());
				if (gname && gweight && gvalue) {
					flag = true;
				}
				return flag;
			}
			window.addEventListener('getinfo', function(eve) {
				$('#gettext').val(eve.detail.info);
			})
			var iw, _this;
			mui('#take-photo').on('tap', '.addclass', function(e) {
				iw = $(this).outerWidth()
				$(this).parent().attr('href', "#");
				_this = this;
			})
			$('.presee').on('tap', function() {
				$(this).addClass('mui-hidden')
			})
			$('.bycamera').on('tap', function() {
				bycamera(_this)
				mui('#delete').popover('toggle')
			})
			$('.bygallery').on('tap', function() {
				bygallery(_this);
				mui('#delete').popover('toggle')
			})
			$('.draft').on('tap', function() {
				openWindow('./draft.html')
			})
			mui.back = function() {
				if ($('#gname').val()) {
					getdata.gName = $('#gname').val();
					getdata.gWeight = $('#gweight').val() || 0;
					getdata.gValue = $('#gvalue').val() || 0;
					getdata.info = $('#gettext').val() || "";
					getdata.pics = setpicid()
					getdata.status = 0;
					console.log(getdata.orderId)
					showobj(getdata)
					mui.confirm('是否保存已填写信息？', '提示', ['确定', '取消'], function(e) {
						if (e.index == 0) {
//							alert(JSON.stringify(getdata));
							mui.ajax(BASEURL + 'order/resOrderByGood', {
								type: 'post',
								data: getdata,
								success: function(data) {
									openNewWindow("./draft.html");
									mui.toast('保存草稿成功！')
								}
							});
						} else {
							plus.webview.currentWebview().close();
							closewebview();
							plus.webview.getLaunchWebview().show('slide-in-left');
							var pages = ["draft", "create-next"]
							for(var i = 0; i < pages.length; i++){
								var tmpage = plus.webview.getWebviewById(pages[i]);
								if(tmpage){
									plus.webview.close(tmpage, "none", 0);
								}
							}
							plus.webview.currentWebview().close("slide-out-right", 200);
						}
					})
				} else {
					plus.webview.currentWebview().close();
					closewebview()
					plus.webview.getLaunchWebview().show('slide-in-left')
				}
			}

			$('.bars').on('tap', function() {})

		
			function closewebview() {
				if (plus.webview.getWebviewById('create-next')) {
					plus.webview.getWebviewById('create-next').close();
				}
				if (plus.webview.getWebviewById('pickaddr')) {
					plus.webview.getWebviewById('pickaddr').close()
				}
				if (plus.webview.getWebviewById('chooseaddr')) {
					plus.webview.getWebviewById('chooseaddr').close();
				}
			}

			function bycamera(contexts) {
				var camera = plus.camera.getCamera();
				var res = camera.supportedImageResolutions[0];
				var fmt = camera.supportedImageFormats[0];
				camera.captureImage(function(path) {
					dealpic(path, contexts)
				})
			}

			function dealpic(path, contexts) {
				plus.io.resolveLocalFileSystemURL(path, function(entry) {
					var local = entry.toLocalURL();
					dealImage(local, {
						width: 17 * 4,
						quality: 0.5
					}, function(base) {
						$(contexts).removeClass('mui-icon-plusempty mui-icon addclass').addClass('mui-spinner')
						console.log("压缩后：" + base.length * 0.8 / 1024 + "KB");
						sendData(BASEURL + "common/file/imgUp", base, contexts, local);
					})
				})
			}

			function bygallery(context) {
				plus.gallery.pick(function(path) {
					dealpic(path, context);
				}, function(e) {
					//					mui.toast('选择图片失败' + e)
					showobj(e)
				}, {
					filter: 'image',
					multiple: false
				})
			}

			function sendData(url, base, context, path) {
				var pics
				mui.ajax(url, {
					type: "post",
					data: {
						imgName: Math.floor(Math.random() * 100000) + ".jpg",
						imgData: base, // base字符串
						dataLength: base.length // base字符串长度
					},
					success: function(data) {
						var img = $('<span class="wids"><img title=' + path + ' src=' + base + ' alt=' + data.res.fid + '></span>');
						$(context).parent().append(img);
						$('img', '.wids').css({
							width: iw,
							height: iw
						})
						$(context).remove();
						setpicid();
					},
					error: function(xhr, type) {
						console.log("错误信息显示：" + type);
						errorhandle(type);
					}
				})
			}

			function setpicid() {
				var pics = [];
				var num = $('#take-photo').find(".wids").length;
				for (var i = 0; i < num; i++) {
					pics[i] = $('img', $('#take-photo').find(".wids").eq(i)).attr('alt');
				}
				return pics.join(',');
			}
			mui('.mui-table-view-cell').on('tap', '.wids', function() {
				$('.presee').removeClass('mui-hidden');
				//					var first = this.children[0].getAttribute('title');
				//					$('.first').attr('src', first);
				//					var haspic = $('.wids');
				//					var len = haspic.length;
				//					for (var i = 0; i < len; i++) { 
				//						var path = $(haspic[i].children[0]).prop('title');
				//						if (path != first) {
				//							var item = $('<div class="mui-slider-item"><a href="#"><img src=' + path + '></a></div>');
				//							$('#preseepic').append(item);
				//						}
				//					}
				var haspic = $('.picpre');
				for (var i = 0; i < 4; i++) {
					if (Boolean($('span', haspic.eq(i)).hasClass('wids'))) {
						
						var path = $('img', haspic.eq(i)).attr('title');
						$('.preimg', '#preseepic').eq(i).attr('src', path)
					} else {
						$('.mui-slider-item', '#preseepic').eq(i).remove()
					}
				}
				//				var gallery = mui('#slider');
				//				gallery.slider().gotoItem(2);
			})

			function dealImage(path, obj, callback) {
				var img = new Image();
				img.src = path;
				img.onload = function() {
					var that = this;
					// 默认按比例压缩
					var w = that.width,
						h = that.height,
						scale = w / h;
					w = obj.width || w;
					h = obj.height || (w / scale);
					var quality = 0.7; // 默认图片质量为0.7
					//生成canvas
					var canvas = document.createElement('canvas');
					var ctx = canvas.getContext('2d');
					// 创建属性节点
					var anw = document.createAttribute("width");
					anw.nodeValue = w;
					var anh = document.createAttribute("height");
					anh.nodeValue = h;
					canvas.setAttributeNode(anw);
					canvas.setAttributeNode(anh);
					ctx.drawImage(that, 0, 0, w, h);
					// 图像质量
					if (obj.quality && obj.quality <= 1 && obj.quality > 0) {
						quality = obj.quality;
					}
					// quality值越小，所绘制出的图像越模糊
					var base64 = canvas.toDataURL('image/jpeg', quality);
					// 回调函数返回base64的值
					callback(base64);
				}
			}
			
			
			
			window.addEventListener('getdraftdata', function(eve) {
				var datas = eve.detail.formdatas;
				console.log('hehehe')
				showobj(datas);
			})
			window.addEventListener('getdraft',function(eve){
				getdata = eve.detail;
			})
			
		})
		
		
		window.addEventListener("draft:datas", function(eve){
			var iw = $('.addclass').outerWidth()
			var datas = JSON.parse(plus.storage.getItem("draft-datas"));
			
			console.log(plus.storage.getItem("draft-datas"));
			
			$("#gname").val(datas.res.gName);		// 商品名
			$("#gweight").val(datas.res.gWeight);
			$("#gvalue").val(datas.res.gValue);
			$("#gettext").val(datas.res.info);
			getdata.orderId = datas.res.orderId;			// 该商品ID
			var html = "<a><span class='mui-icon mui-icon-plusempty addclass'></span></a>";
			$(".img-box").html(html);
			
			if(datas.res.pics.length > 0){
				var n = BASEURL.indexOf('/api/');
				var per = BASEURL.substring(0,n);
				var pic = datas.res.pics;
				var len = pic.length;
				console.log(JSON.stringify(pic));
				if(len > 0){
					for(var i = 0; i<len;i++){
						var url = per + pic[i].path;
						var html = '<a><span class="wids"><img alt="'+ pic[i].id +'" title="'+ url +'" height="'+ iw +'px" width="'+ iw +'px" src=' + url +'></span></a>';
						console.log(html)
						document.querySelectorAll(".img-box")[i].innerHTML = html;
					}
				}
			}
//			alert(plus.storage.getItem("draft-datas"))
		})
	</script>
</html>