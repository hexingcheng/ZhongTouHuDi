<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="common.css"/>
		<link rel="stylesheet" href="../../css/mui.listpicker.css" />
		<link rel="stylesheet" href="../../css/mui.dtpicker.css" />
		<script src="../../js/mui.min.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
			}
			html,
			body,
			.mui-content {
				background-color: #FFFFFF;
			}
			.mui-bar {
				background-color: #3ba767;
			}
			.mui-bar h1,
			.mui-bar a {
				color: #FFFFFF;
			}
			.draft {
				color: #FFFFFF;
			}
			@font-face {
				font-family: "iconfont";
				src: url('../../icon/iconfont.eot');
				/* IE9*/
				
				src: url('../../icon/iconfont.eot?#iefix') format('embedded-opentype'),
				/* IE6-IE8 */
				
				url('../../icon/iconfont.woff') format('woff'),
				/* chrome、firefox */
				
				url('../../icon/iconfont.ttf') format('truetype'),
				/* chrome、firefox、opera、Safari, Android, iOS 4.2+*/
				
				url('../../icon/iconfont.svg#iconfont') format('svg');
				/* iOS 4.1- */
			}
			.iconfont {
				font-family: "iconfont" !important;
				font-size: 16px;
				font-style: normal;
				-webkit-font-smoothing: antialiased;
				-webkit-text-stroke-width: 0.2px;
				-moz-osx-font-smoothing: grayscale;
			}
			.icon-wenjian:before {
				content: "\e600";
			}
			.mui-scroll-wrapper {
				margin-top: 44px;
				margin-bottom: 44px;
			}
			.fl {
				float: left;
			}
			.fr {
				float: right;
			}
			.clear {
				zoom: 1;
			}
			.clear:after {
				content: "";
				display: block;
				clear: both;
			}
			.wid10 {
				width: 10%;
			}
			.wid30 {
				width: 30%;
			}
			.wid60 {
				width: 60%;
			}
			.wid80 {
				width: 80%;
			}
			.wid90 {
				width: 90%;
			}
			.hei80 {
				height: 60px;
			}
			.linehei {
				line-height: 60px;
			}
			.paddl10 {
				padding-left: 10px;
			}
			.color5f {
				color: #5f5d5d;
			}
			.iptwrap {
				height: 30px;
				margin: 15px 0;
			}
			.iptwrap input {
				border: 0;
				background-color: #F7F5F5;
				color: #219B52;
				height: 30px;
				padding: 0;
			}
			.tet {
				text-align: center;
				line-height: 60px;
				color: #a1a1a1;
			}
			.gap {
				height: 10px;
				background-color: #F2F2F2;
			}
			.time input {
				border: 0;
			}
			.addborb,
			.times,
			.address,
			.host,
			.phone,
			.receiver {
				border-bottom: 1px solid #e8e8e8;
			}
			#footer {
				height: 60px;
				background-color: #FFFFFF;
				padding: 10px 20px;
			}
			.next-step {
				text-align: center;
				background-color: #3ba767;
				width: 100%;
				height: 100%;
				line-height: 40px;
				color: #ceefe4;
			}
			.insurea {
				color: #5F5D5D;
			}
			.insure {
				padding-bottom: 10px;
			}
			.order-content {
				padding-bottom: 50px;
			}
			.lmar {
				margin-left: -10px;
			}
			#radio:before {
				color: #3ba767;
			}
			.mui-input-row .mui-input-clear~.mui-icon-clear,
			.mui-input-row .mui-input-speech~.mui-icon-speech {
				top: 18px;
			}
			#closeicon .mui-icon-clear {
				top: 5px;
			}
			#gettime,
			#respecttime,
			#getaddr,
			#sendaddr {
				padding-left: 15px;
				color: #bec0c2;
			}
			div.mui-scroll-wrapper {top: 8px;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">create order</h1>
		</header>
		<footer class="mui-bar mui-bar-footer" id="footer">
			<div class="next-step mui-bbtn" id="next">Next Step</div>
		</footer>
		<!--<div class="mask mui-hidden"></div>
		<div class="faorder mui-hidden">发单中</div>-->
		<div class="mui-content">
			<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div class="order-content">
						<div class="reword clear">
							<div class="fl wid30 hei80 paddl10 color5f linehei">Reword</div>
							<div class="fl wid60 hei80">
								<div class="iptwrap mui-input-row" id="closeicon">
									<input type="number" class="ipt mui-input-clear" id="pay" />
								</div>
							</div>
							<div class="fr wid10 hei80 tet">
								$
							</div>
						</div>
						<div class="gap"></div>
						<div class="times">
							<div class="clear pict">
								<div class="fl wid10 hei80 linehei mui-text-right">
									<span class="mui-icon mui-icon-flag"></span>
								</div>
								<div class="fl wid80 hei80 linehei addborb">
									<div id="gettime" class="gettimes" data-time="">Pickup Time</div>
								</div>
								<div class="fr wid10 hei80 linehei tet addborb">
									<span class="mui-icon mui-icon-arrowright"></span>
								</div>
							</div>
							<div class="arrtime clear">
								<div class="fl wid10 hei80 linehei mui-text-right">
									<span class="mui-icon mui-icon-locked"></span>
								</div>
								<div class="fl wid80 hei80 linehei">
									<div id="respecttime" class="gettimes" data-time="">Arrival Time</div>
								</div>
								<div class="fr wid10 hei80 linehei tet">
									<span class="mui-icon mui-icon-arrowright"></span>
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="address">
							<div class="clear" id="pict">
								<div class="fl wid10 hei80 linehei mui-text-right">
									<span class="mui-icon mui-icon-location"></span>
								</div>
								<div class="fl wid80 hei80 linehei addborb">
									<div id="getaddr" data-addr="重庆" data-Jd="106.60111939165672" data-Wd="29.53408157290842">Pickup Address</div>
								</div>
								<div class="fr wid10 hei80 linehei tet addborb">
									<span id="send-address" class="mui-icon mui-icon-bars"></span>
								</div>
							</div>
							<div class="clear">
								<div class="fl wid10 hei80 linehei mui-text-right">
									<span class="mui-icon mui-icon-map"></span>
								</div>
								<div class="fl wid80 hei80 linehei">
									<div id="sendaddr" data-addr="北京" data-Jd="10" data-Wd="10">Receive address</div>
								</div>
								<div class="fr wid10 hei80 linehei tet">
									<span id="receive-address" class="mui-icon mui-icon-bars"></span>
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="host clear">
							<div class="fl wid10 hei80 linehei mui-text-right">
								<span class="mui-icon mui-icon-person"></span>
							</div>
							<div class="fl wid80 hei80 linehei">
								<div class="mui-input-row time">
									<input type="text" class="mui-input-clear" placeholder="Host" id="sender" />
								</div>
							</div>
							<div class="fr wid10 hei80 linehei tet">
								<span id="sender-contact" class="mui-icon mui-icon-contact"></span>
							</div>
						</div>
						<div class="phone clear">
							<div class="fl wid10 hei80 linehei mui-text-right">
								<span class="mui-icon mui-icon-phone"></span>
							</div>
							<div class="fl wid90 hei80 linehei">
								<div class="mui-input-row time">
									<input type="tel" class="mui-input-clear" placeholder="Phone" id="contact" />
								</div>
							</div>
						</div>
						<div class="gap"></div>
						<div class="receiver clear">
							<div class="fl wid10 hei80 linehei mui-text-right">
								<span class="mui-icon mui-icon-personadd"></span>
							</div>
							<div class="fl wid80 hei80 linehei">
								<div class="mui-input-row time">
									<input type="text" class="mui-input-clear" placeholder="receiver" id="receiver" />
								</div>
							</div>
							<div class="fr wid10 hei80 linehei tet">
								<span id="receiver-contact" class="mui-icon mui-icon-contact"></span>
							</div>
						</div>
						<div class="phone clear">
							<div class="fl wid10 hei80 linehei mui-text-right">
								<span class="mui-icon mui-icon-phone"></span>
							</div>
							<div class="fl wid90 hei80 linehei">
								<div class="mui-input-row time">
									<input type="text" class="mui-input-clear" placeholder="Phone" id="tel" />
								</div>
							</div>
						</div>
						<div class="insure">
							<form class="mui-input-group">
								<div class="mui-input-row mui-checkbox mui-left">
									<label class="insurea lmar">Buy safety insurance $5</label>
									<input name="radio1" type="checkbox" class="lmar" value="5" id="comer">;
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		</div>
		<script type="text/javascript" src="../../js/mui.listpicker.js"></script>
		<script type="text/javascript" src="../../js/mui.dtpicker.js"></script>
		<script type="text/javascript" src="../../js/utils.js"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			mui.plusReady(function() {
				var getdata = {};
				getdata.gName = "";
				getdata.gValue = "";
				getdata.gWeight = "";
				getdata.pics = "";
				getdata.info = "";
				getdata.money = "";
				getdata.getTime = "";
				getdata.finTime = "";
				getdata.senderAddress = "";
				getdata.receiverAddress = "";
				getdata.sender = "";
				getdata.senderPhone = "";
				getdata.sendJd = "";
				getdata.sendWd = "";
				getdata.receiver = "";
				getdata.receiverPhone = "";
				getdata.receiverJd = "";
				getdata.receiverWd = "";
				getdata.insType = "";
				getdata.status = "";
				var c = plus.webview.currentWebview();
				mui('#offCanvasSideScroll').scroll();
				c.setStyle({
					scrollIndicator: 'none'
				})
				
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(pos) {
						lot = pos.coords.longitude;
						lat = pos.coords.latitude;
						$('#getaddr').attr('data-Jd', lot)
						$('#getaddr').attr('data-Wd', lat)
						$('#sendaddr').attr('data-Jd', lot)
						$('#sendaddr').attr('data-Wd', lat)
						var c = plus.webview.currentWebview();
						var onOff = true;
						$('.mui-bbtn').on('tap', function() {
							
							var data = JSON.parse(plus.storage.getItem("draft-datas"))
							if(data && data.res && data.res.orderId){
								getdata.orderId = data.res.orderId;
							}
							
							getdata.gName = c.gName;
							getdata.gValue = c.gValue;
							getdata.gWeight = c.gWeight;
							getdata.pics = c.pics;
							getdata.info = c.info;
							getdata.money = parseInt($('#pay').val());
							getdata.getTime = $('#gettime').attr('data-time');
							getdata.finTime = $('#respecttime').attr('data-time');
							getdata.senderAddress = $('#getaddr').attr('data-addr');
							getdata.receiverAddress = $('#sendaddr').attr('data-addr');
							getdata.sender = $('#sender').val();
							getdata.senderPhone = $('#contact').val();
							getdata.sendJd = $('#getaddr').attr('data-Jd');
							getdata.sendWd = $('#getaddr').attr('data-Wd');
							getdata.receiver = $('#receiver').val();
							getdata.receiverPhone = $('#tel').val();
							getdata.receiverJd = $('#sendaddr').attr('data-Jd');
							getdata.receiverWd = $('#sendaddr').attr('data-Wd');
							getdata.insType = parseInt($('#comer').val());
							getdata.status = 1;
							if (getdata.money && getdata.getTime && getdata.senderAddress && getdata.receiverAddress && getdata.sender && getdata.senderPhone) {
								if (onOff) {
									onOff = false
									plus.nativeUI.showWaiting('发送中')
									mui.ajax(BASEURL + 'order/resOrderByGood', {
										data: getdata,
										type: 'post',
										timeout:10000,
										success: function(data) {
											
											plus.storage.removeItem("draft-datas");		// 返回时清楚storage中储存的数据
											
											if (data.ret == 1) {
												plus.nativeUI.closeWaiting();
												mui.toast('发单成功');
												openWindow('./result.html')
											} else if (data.ret == -101) {
												mui.confirm('您还未登陆，请登录！', '提示', ['确定', '取消'], function(e) {
													if (e.index == 0) {
														openWindow('../login-up.html');
													} else {
														return;
													}
												})
											}
										},
										error: function(xhr, type) {
											onOff = true;
											plus.nativeUI.closeWaiting()
											console.log(type)
										}
									})
								}
							} else {
								mui.toast('信息未填完全')
							}
						})
					}, function() {
						mui.toast('获取位置信息失败')
					}, {
						enableHighAcuracy: true
					})
				} else {
					mui.toast('获取位置信息失败')
				}
				
				
				$('.pict,.arrtime').on('tap', function() {
					var _this = $(this);
					var options = {
						"type": "hour",
						"beginYear": 2015,
						"endYear": 2015,
						"customData": {
							"h": [{
								"text": "上午",
								"value": "上午"
							}, {
								"text": "下午",
								"value": "下午"
							}, {
								"text": "晚上",
								"value": "晚上"
							}]
						},
						"labels": ["年", "月", "日", "时段", "分"]
					}
					var time = new mui.DtPicker(options);
					time.show(function(rs) {
						$('.gettimes', _this).attr('data-time', rs.text);
						$('.gettimes', _this).text(rs.text).css('color', "#000")
					})
				})
				$('#getaddr,#sendaddr').on('tap', function() {
					setstorage('getaddr', $(this).text())
					openWindow('./pickaddr.html')
				})
				window.addEventListener('getaddrs', function(eve) {
					var addr = eve.detail.addrs;
					var mylocation = eve.detail.mylocation;
					if (getstorage('getaddr') == 'Pickup Address') {
						$('#getaddr').attr('data-Jd', mylocation.K)
						$('#getaddr').attr('data-Wd', mylocation.G)
						$('#getaddr').attr('data-addr', addr)
						$('#getaddr').text(addr).css('color', "#000")
					} else {
						$('#sendaddr').attr('data-Jd', mylocation.K);
						$('#sendaddr').attr('data-Wd', mylocation.G);
						$('#sendaddr').attr('data-addr', addr)
						$('#sendaddr').text(addr).css('color', "#000")
					}
				})
				
				// 获取草稿信息
				var datas = JSON.parse(plus.storage.getItem("draft-datas"));
				if(datas && datas.res.orderId && datas.res.gName){
					$('#pay').val(datas.res.money);			// 奖励
					$('#gettime').attr('data-time', datas.res.getTime);		// 属性取值
					$('#gettime').html(datas.res.getTime);		// 显示值
					$('#respecttime').attr('data-time', datas.res.finTime);
					$('#respecttime').html(datas.res.finTime);
					$('#getaddr').attr('data-addr', datas.res.sendAddr);		// 地址属性取值
					$('#getaddr').html(datas.res.sendAddr)		// 地址属性值显示
					$('#sendaddr').attr('data-addr', datas.res.receiveAddr);
					$('#sendaddr').html(datas.res.receiveAddr);
					
					$('#sender').val(datas.res.sender);
					$('#contact').val(datas.res.senderPhone);
					$('#receiver').val(datas.res.receiver);
					$('#tel').val(datas.res.receiverPhone);
				}
				
				
				// 返回按钮时进行数据存储
				var back = mui.back;
				mui.back = function() {
					draftdata();
					back();
				}
				// 获取草稿信息
				function draftdata() {
					
					if(c.orderId){
						getdata.orderId = c.orderId;
					}
					
					getdata.gName = c.gName;
					getdata.gValue = c.gValue;
					getdata.gWeight = c.gWeight;
					getdata.pics = c.pics;
					getdata.info = c.info;
					getdata.money = parseInt($('#pay').val());
					getdata.getTime = $('#gettime').attr('data-time');
					getdata.finTime = $('#respecttime').attr('data-time');
					getdata.senderAddress = $('#getaddr').attr('data-addr');
					getdata.receiverAddress = $('#sendaddr').attr('data-addr');
					getdata.sender = $('#sender').val();
					getdata.senderPhone = $('#contact').val();
					getdata.sendJd = $('#getaddr').attr('data-Jd');
					getdata.sendWd = $('#getaddr').attr('data-Wd');
					getdata.receiver = $('#receiver').val();
					getdata.receiverPhone = $('#tel').val();
					getdata.receiverJd = $('#sendaddr').attr('data-Jd');
					getdata.receiverWd = $('#sendaddr').attr('data-Wd');
					getdata.insType = parseInt($('#comer').val());
					getdata.status = 0;
					var opener = plus.webview.currentWebview().opener();
					mui.fire(opener,'getdraft',getdata)
				}
				
				// 选择发送者联系方式
				document.getElementById("sender-contact").addEventListener("tap", function(){
					findContact();
					setstorage("order-type", "sender");
					openWindow("./choose-contact.html");
				}, false)    
				
				document.getElementById("receiver-contact").addEventListener("tap", function(){
					findContact();
					setstorage("order-type", "receiver");
					openWindow("./choose-contact.html");
				}, false)
				
				// 查询联系人列表
				function findContact(){
					plus.contacts.getAddressBook(plus.contacts.ADDRESSBOOK_PHONE, function (addressbook) {
						addressbook.find(["displayName","phoneNumbers"],function(contacts){
							var lists = [];
							for(var i = 0; i < contacts.length; i++){
								var phonenum = contacts[i].phoneNumbers;
								var obj = {
									index : (i+1),
									name : contacts[i].displayName
								}
								if(phonenum.length == 0){
									break;
								}
								
								for(var j = 0; j < phonenum.length; j++){
									obj.contact = phonenum[j].value;
									lists.push(obj);
								}
							}
//							console.log(JSON.stringify(lists))
							plus.storage.setItem("contacts", JSON.stringify(lists));
						}, function ( err ) {
							console.log("查找错误 :"+ err.message);
						},{multiple:true});
					},function(e){
						console.log("Get address book failed: " + e.message);
					});
				}
				
				window.addEventListener("order:sender", function(eve){
//					alert(eve.detail.name);

					$("#sender").val(eve.detail.name);
					$("#contact").val(eve.detail.tel);
				})
				
				window.addEventListener("order:receiver", function(eve){
					$("#receiver").val(eve.detail.name);
					$("#tel").val(eve.detail.tel);
				})
				
			})
		</script>
	</body>

</html>